(function(g){var window=this;'use strict';var bmZ=function(m){const F=new g.Rr("und",new g.E8("Default","und",!0));F.captionTracks=m.captionTracks;return F},cPt=function(m){return new g.X3(function(F,L){let u=m.length;
const q=[];if(u){var A=function(G,v){u--;q[G]=v;u==0&&F(q)},r=function(G){L(G)};
for(let G=0;G<m.length;G++){var y=m[G];g.Qu(y,g.qN(A,G),r)}}else F(q)})},drm=function({type:m,
payload:F}){m={type:m};F!==void 0&&(m.payload=F);return m},$V=function(m){m=m.key||m.id;
if(!m)throw Error("Entity key is missing");return m},nZZ=function(){if(eF)return eF();
eF=g.wU("PersistentEntityStoreDb",{Tx:{EntityStore:{FL:1},EntityAssociationStore:{FL:2}},shared:!1,upgrade(m,F){F(1)&&g.BZ(g.dc(m,"EntityStore",{keyPath:"key"}),"entityType","entityType");F(2)&&(m=g.dc(m,"EntityAssociationStore",{keyPath:["parentEntityKey","childEntityKey"]}),g.BZ(m,"byParentEntityKey","parentEntityKey"),g.BZ(m,"byChildEntityKey","childEntityKey"))},version:3});return eF()},B$q=function(m){return g.L$(nZZ(),m)},PU=function(m){return g.L$((0,g.qqN)(),m)},HmC=function(m){return m instanceof
Error?new i_("UNKNOWN_ENCODE_ERROR",{originalMessage:m.message}):new i_("UNKNOWN_ENCODE_ERROR")},JPm=function(m){return m instanceof Error?new i_("UNKNOWN_DECODE_ERROR",{originalMessage:m.message}):new i_("UNKNOWN_DECODE_ERROR")},CCm=function(m,F){m=m instanceof i_?m:F(m);
g.Q(m);throw m;},m1C=function(m,F,L){try{return m.G(F,L)}catch(u){CCm(u,HmC)}},gk=function(m){m=(new TextEncoder).encode(m).subarray(0,16);
const F=new Uint8Array(16);F.set(m);return F},LoC=function(m){const F=Foq[m];
if(F)return F;g.x2(new g.Dj("Entity model not found.",{entityType:m}))},YV=function(m,F){a:{m=zy(m.B,F.version);
try{var L=m.B(F.data,F.key);break a}catch(u){CCm(u,JPm)}L=void 0}return L},aA=function(m,F,L){return m.X.objectStore("EntityStore").get(F).then(u=>{if(u){if(L&&u.entityType!==L)throw Error("Incorrect entity type");
return YV(m,u)}})},D7=function(m,F,L){return L?(L=L.map(u=>aA(m,u,F)),g.hW.all(L)):m.X.objectStore("EntityStore").index("entityType").getAll(IDBKeyRange.only(F)).then(u=>u.map(q=>YV(m,q)))},qiq=function(m,F,L){const u=$V(F);
return Ty(m,u).then(()=>uNt(m,F,L))},NE=function(m,F,L){let u=m.G[L];
u||(u=new Set,m.G[L]=u);u.add(F)},p6=function(m,F,L){const u=$V(F),q=zy(m.B,1),A={...F};
return m.X.objectStore("EntityStore").get(u).then(r=>{if(r){if(r.entityType!==L)throw Error("Incorrect entity type");A.entityMetadata||(r=YV(m,r),A.entityMetadata=r.entityMetadata)}}).then(()=>{const r={key:u,
entityType:L,data:m1C(q,A,u),version:1};return g.hW.all([m.X.objectStore("EntityStore").put(r),qiq(m,A,L)])}).then(()=>{NE(m,u,L);
return u})},K6=function(m,F,L){F=F.map(u=>p6(m,u,L));
return g.hW.all(F)},raC=function(m,F,L){if(L.has(F))return g.hW.resolve(void 0);
L.add(F);return Aae(m,F).then(u=>m.X.objectStore("EntityAssociationStore").index("byParentEntityKey").delete(IDBKeyRange.only(F)).then(()=>u)).then(u=>{let q=g.hW.resolve(void 0);
for(const A of u)q=q.then(()=>raC(m,A,L));
return q}).then(()=>{})},f6=function(m,F,L){if(L?.xZ){const q=new Set;
return raC(m,F,q).then(()=>{const A=[];for(const r of q)A.push(f6(m,r));return g.hW.all(A).then(()=>{})})}const u=g.cf(F).entityType;
return g.hW.all([m.X.objectStore("EntityStore").delete(F),Ty(m,F)]).then(()=>{NE(m,F,u)})},Ty=function(m,F){return m.X.objectStore("EntityAssociationStore").index("byParentEntityKey").delete(IDBKeyRange.only(F))},xV=function(m,F){return g.mX(m.X.objectStore("EntityStore").index("entityType"),{query:IDBKeyRange.only(F)},L=>g.hW.all([L.delete(),
Ty(m,L.cursor.primaryKey)]).then(()=>{NE(m,L.cursor.primaryKey,F);return g.C5(L)}))},ya8=function(m,F,L,u){const q=zy(m.B,1);
return aA(m,F,u).then(A=>{if(A){A=g.lg(A,L);var r={key:F,entityType:u,data:m1C(q,A,F),version:1};return g.hW.all([m.X.objectStore("EntityStore").put(r),qiq(m,A,u)])}}).then(()=>{NE(m,F,u);
return F})},uNt=function(m,F,L){const u=$V(F);
L=LoC(L);if(!L)return g.hW.resolve([]);F=new L(F);m=m.X.objectStore("EntityAssociationStore");L=[];for(const q of F.B())L.push(m.put({parentEntityKey:u,childEntityKey:q}));return g.hW.all(L).then(q=>q.map(A=>A[1]))},Aae=function(m,F){const L=m.X.objectStore("EntityAssociationStore");
return L.index("byParentEntityKey").getAll(IDBKeyRange.only(F)).then(u=>{const q=[];for(const A of u)q.push(L.index("byChildEntityKey").getAll(A.childEntityKey));return g.hW.all(q)}).then(u=>{const q=[];
for(const A of u)A.length===1&&q.push(A[0].childEntityKey);return q})},zy=function(m,F=0){m=m.X[F];
if(!m)throw F=new i_("INVALID_ENCODER_VERSION",{aO:F}),g.Q(F),F;return m},GfC=function(m,F){for(const L of m.observers)L(F)},ME=async function(m,F,L){var u=await B$q(m.token);
let q;F=await g.cZ(u,["EntityStore","EntityAssociationStore"],F,A=>{q=new vqc(A,m.X);return L(q)});
q&&(u=q.G,Object.keys(u).length>0&&(m.channel.postMessage(u),GfC(m,u)));return F},Z7=function(m,F,L){return ME(m,{mode:"readwrite",
JW:!0},u=>p6(u,F,L))},lX6=function(m,F){return ME(m,{mode:"readwrite",
JW:!0},L=>K6(L,F,"offlineOrchestrationActionWrapperEntity"))},SF=function(m,F){return ME(m,{mode:"readwrite",
JW:!0},L=>f6(L,F))},whC=function(m){return ME(m,{mode:"readwrite",
JW:!0},F=>xV(F,"videoPlaybackPositionEntity"))},oA=function(m,F,L){return ME(m,{mode:"readonly",
JW:!0},u=>aA(u,F,L))},Xu=function(m,F,L){return ME(m,{mode:"readonly",
JW:!0},u=>D7(u,F,L))},IXC=async function(){try{const F=await g.l6();
if(F&&g.PZ()&&typeof g.On.BroadcastChannel!=="undefined"){var m=new V_e;return new juC(F,m)}}catch(F){F instanceof Error&&g.Q(F)}},ET=function(){tD||(tD=IXC());
return tD},RSG=function(m){m=m.options?.persistenceOption;
return m==="ENTITY_PERSISTENCE_OPTION_PERSIST"||m==="ENTITY_PERSISTENCE_OPTION_INMEMORY_AND_PERSIST"},$1G=async function(m){const F=await ET();
F&&await ME(F,"readwrite",L=>{const u={};for(const q of m){if(!q.entityKey||!RSG(q))continue;const A=g.B2(q.payload);let r=void 0;q.type==="ENTITY_MUTATION_TYPE_REPLACE"&&(r=()=>p6(L,q.payload[A],A));
q.type==="ENTITY_MUTATION_TYPE_DELETE"&&(r=()=>f6(L,q.entityKey));
q.type==="ENTITY_MUTATION_TYPE_UPDATE"&&(r=()=>ya8(L,q.entityKey,q.payload[A],A));
r&&(u[q.entityKey]=u[q.entityKey]?u[q.entityKey].then(r):r())}return g.hW.all(Object.values(u))})},UT=async function(m){!(m=m.mutations)||m.length<=0||(g.m2&&g.m2.dispatch(drm({type:"ENTITY_LOADED",
payload:m})),await $1G(m),m.length=0)},eS8=function(m){return m!==void 0},PmC=function(m){var F=g.Sz();
F=Object.assign({},F);m=Object.assign({},m);for(const L in F)m[L]?(F[L]!==4&&(F[L]=m[L]),delete m[L]):F[L]!==2&&(F[L]=4);Object.assign(F,m);g.BDv(F);JSON.stringify(F);return F},iG8=async function(m){const F=await g.l6();
return F?g.cZ(await g.tH(F),["index","media","captions"],{mode:"readwrite",JW:!0},L=>{const u=IDBKeyRange.bound(m+"|",m+"~");L=[L.objectStore("index").delete(u),L.objectStore("media").delete(u),L.objectStore("captions").delete(u)];return g.hW.all(L).then(()=>{})}):void 0},gq2=async function(){const m=await g.l6();
if(!m)throw g.kr("rvdfd");return g.cZ(await g.tH(m),["index","media"],{mode:"readwrite",JW:!0},F=>{const L={};return g.JW(F.objectStore("index"),{},u=>{var q=u.cursor.key.match(/^([\w\-_]+)\|(a|v)$/);let A=g.hW.resolve(void 0);if(q){const r=q[1];q=q[2];L[r]=L[r]||{};L[r][q]=g.mIM(u.getValue()?.fmts)}else A=u.delete().then(()=>{});
return g.hW.all([g.C5(u),A]).then(([r])=>r)}).then(()=>{const u={};
for(const A of Object.keys(L)){const r=L[A].v;u[A]=L[A].a&&r?1:2}const q=PmC(u);return g.xub(F.objectStore("media"),{},A=>{const r=A.cursor.key.match(g.qUy);r&&u[r[1]]||F.objectStore("media").delete(A.cursor.key);return g.YGA(A)}).then(()=>q)})})},zSe=async function(m,F){var L=await g.l6();
if(!L)throw g.kr("wct");L=await g.tH(L);await g.cZ(L,["captions"],{mode:"readwrite",JW:!0},u=>{const q=[];u=u.objectStore("captions");for(let A=0;A<F.length;A++){const r=u.put(F[A],m+"|"+F[A].metadata.vss_id);q.push(r)}return g.hW.all(q)})},Yi8=async function(m){m=IDBKeyRange.bound(m+"|",m+"~");
const F=await g.l6();if(!F)throw g.kr("gactfv");return(await g.tH(F)).getAll("captions",m)},aXG=async function(m){g.XO(m,0);
return iG8(m)},D1c=function(m){return{context:g.q$(),
videoIds:m}},Tet=function(m){return{context:g.q$(),
playlistIds:m}},Nee=function(m){return{context:g.q$(),
offlinePlaylistSyncChecks:m}},KoC=function(){kV||(kV=new phc);
return kV},fXe=function(m,F){return{eventType:{flowEventNamespace:"FLOW_EVENT_NAMESPACE_OFFLINE_ORCHESTRATION",
flowEventType:m},metadata:F,statusCode:void 0,csn:void 0,can:void 0}},x1C=function(m,F,L){L||(L=m.X.get("FLOW_TYPE_OFFLINE_ORCHESTRATION"),L||(L=g.$H(16),m.X.set("FLOW_TYPE_OFFLINE_ORCHESTRATION",L)));
m={flowNonce:L,flowType:"FLOW_TYPE_OFFLINE_ORCHESTRATION",flowEventType:F.eventType};F.metadata&&(m.flowMetadata=F.metadata);F.statusCode!==void 0&&(m.flowEventStatus=F.statusCode);F.csn&&(m.csn=F.csn);F.can&&(m.can=F.can);g.RT("flowEvent",m,void 0)},M_R=async function(m){var F=await ME(m,{mode:"readonly",
JW:!0},I=>D7(I,"playbackData").then(P=>{var N=P.map(t=>t.transfer).filter(t=>!!t),x=P.map(t=>t.offlineVideoPolicy).filter(t=>!!t),X=P.filter(t=>!!t.key).map(t=>g.dD(g.cf(t.key).entityId,"downloadStatusEntity"));
N=D7(I,"transfer",N);x=D7(I,"offlineVideoPolicy",x);X=D7(I,"downloadStatusEntity",X);const M=N.then(t=>{t=t.reduce((h,qb)=>{qb?.offlineVideoStreams&&h.push(...qb.offlineVideoStreams);return h},[]).filter(h=>!!h);
return D7(I,"offlineVideoStreams",t)});
return g.hW.all([N,x,M,X]).then(([t,h,qb,yv])=>[P,t,h,qb,yv])}));
m=await ME(m,{mode:"readonly",JW:!0},I=>D7(I,"mainDownloadsListEntity").then(P=>P[0]?.downloads??[]));
const [L,u,q,A,r]=F,y={},G={},v={},l={},w={};F=[];for(var V of u)V&&(y[V.key]=V);for(const I of q)I&&(G[I.key]=I);for(const I of r)I&&(v[I.key]=I);for(const I of A)I&&(l[I.key]=I);for(const I of m)w[I.videoItem??""]=!0,I.videoItem&&(V=g.cf(I.videoItem)?.entityId??"",F.push({externalVideoId:V}));return{offlineVideos:L.filter(I=>{if(!I||!I.key||!I.offlineVideoPolicy)return!1;I=g.cf(I.key).entityId;I=g.dD(I,"downloadStatusEntity");return!(I&&v[I]?.downloadState==="DOWNLOAD_STATE_USER_DELETED")}).map(I=>
{var P=y[I.transfer];
const N=[];if(P?.offlineVideoStreams)for(var x of P.offlineVideoStreams){var X=l[x];X&&N.push(X)}x=G[I.offlineVideoPolicy];X=I?.playerResponseTimestamp;var M=g.cf(x.key).entityId;I=g.dD(M,"mainVideoEntity");if(x.action==="OFFLINE_VIDEO_POLICY_ACTION_DISABLE"){var t="OFFLINE_VIDEO_STATE_DISABLED";x.expirationTimestamp&&Number(x.expirationTimestamp)<Date.now()/1E3&&(t="OFFLINE_VIDEO_STATE_EXPIRED")}else if(x.action==="OFFLINE_VIDEO_POLICY_ACTION_DOWNLOAD_FAILED")t="OFFLINE_VIDEO_STATE_OFFLINE_FAILED";
else{switch(P?.transferState){case "TRANSFER_STATE_TRANSFER_IN_QUEUE":t="OFFLINE_VIDEO_STATE_PENDING";break;case "TRANSFER_STATE_TRANSFERRING":t="OFFLINE_VIDEO_STATE_TRANSFERRING";break;case "TRANSFER_STATE_PAUSED_BY_USER":t="OFFLINE_VIDEO_STATE_PAUSED_TRANSFER";break;case "TRANSFER_STATE_FAILED":t="OFFLINE_VIDEO_STATE_OFFLINE_FAILED";break;case "TRANSFER_STATE_COMPLETE":t="OFFLINE_VIDEO_STATE_PLAYABLE";break;case "TRANSFER_STATE_WAITING_FOR_PLAYER_RESPONSE_REFRESH":t="OFFLINE_VIDEO_STATE_STREAMS_OUT_OF_DATE";
break;default:t="OFFLINE_VIDEO_STATE_UNKNOWN"}if(t==="OFFLINE_VIDEO_STATE_OFFLINE_FAILED")switch(P?.failureReason){case "TRANSFER_FAILURE_REASON_EXTERNAL_FILESYSTEM_WRITE":case "TRANSFER_FAILURE_REASON_FILESYSTEM_WRITE":t="OFFLINE_VIDEO_STATE_OUT_OF_STORAGE_ERROR";break;case "TRANSFER_FAILURE_REASON_STREAM_MISSING":t="OFFLINE_VIDEO_STATE_STREAMS_MISSING";break;case "TRANSFER_FAILURE_REASON_NETWORK":case "TRANSFER_FAILURE_REASON_NETWORK_LOST":t="OFFLINE_VIDEO_STATE_NETWORK_ERROR"}}M={id:M,videoState:t};
P?.cotn&&(M.cotn=P.cotn);P?.maximumDownloadQuality&&(M.selectedVideoQuality=P?.maximumDownloadQuality);P?.lastProgressTimeMs&&(M.lastProgressTimeMs=P.lastProgressTimeMs);X&&(M.playerResponseSavedTimeMs=String(Number(X)*1E3));P=String;X=0;for(const h of N)if(h.streamsProgress)for(const qb of h.streamsProgress)X+=Number(qb.numBytesDownloaded??0);M.downloadedBytes=P(X);M.selectedOfflineMode=w[I]?"OFFLINE_MODE_TYPE_AUTO_OFFLINE":"OFFLINE_NOW";x.action==="OFFLINE_VIDEO_POLICY_ACTION_DISABLE"&&(M.offlinePlaybackDisabledReason=
x.offlinePlaybackDisabledReason);return M}),
additionalOfflineClientState:{mainAppAdditionalOfflineClientState:{smartDownloadVideos:F}}}},SiZ=function(){try{let L=g.sn("ytglobal.locks_");
if(L)return L;var m;if(m=navigator){var F=navigator;m="locks"in F&&!!F.locks}if(m)return g.On.localStorage&&g.On.localStorage.getItem("noop"),L=new ZG2,g.Qv("ytglobal.locks_",L),L}catch{}},hD=function(m){if(m.includes(":"))throw Error(`Invalid user cache name: ${m}`);
return`${m}:${g.ej("CacheStorage get")}`},oqC=async function(){return WU!==void 0?WU:WU=new Promise(async m=>{try{await OT.open("test-only"),await OT.delete("test-only")}catch(F){if(F instanceof Error&&F.name==="SecurityError"){m(!1);
return}}m("caches"in window)})},sT=async function(){if(await oqC())return Qx||(Qx=new XhC),Qx},b_=function(m,F,L){g.x2(new g.Dj(`Woffle: ${m}`,L?{cotn:L}:""));
F instanceof Error&&g.x2(F)},t_Z=async function(m){m=await M_R(m);
g.RT("offlineStateSnapshot",m)},cU=function(m,F){g.sP(m.api,"onOfflineOperationFailure",F);
m.X?.postMessage(F)},EqZ=function(m){if(!m.G&&!m.X){var F=SiZ();
if(F){m.G=!0;var L=g.ej("OfflineLockManager");F.request(`${"woffle_orchestration_leader"}:${L}`,{},async()=>{try{m.B=new g.lT,m.X=!0,m.G=!1,await m.Z(),await m.B.promise}catch(u){m.W8(),u instanceof Error&&(u.args=[{name:"WoLockManagerError",GT:u.name}],g.Q(u))}})}}},dk=function(m){m.L&&m.j&&m.O&&m.visibility.isBackground()?m.V.wJ(6E4):m.V.stop()},U1N=function(m){m.X&&(m.O=!0,dk(m))},kfR=function(m,F){m.X&&(m.j=F,dk(m))},hSC=function(m,F){m.X&&(m.L=F,dk(m))},n6=function(m){m.offlineDeleteReason=m.offlineDeleteReason??
"OFFLINE_DELETE_REASON_UNKNOWN";
m.offlineModeType=m.offlineModeType??"OFFLINE_NOW";g.RT("offlineDeleteEvent",m)},BU=function(m,{videoId:F,
cM:L,offlineModeType:u}){m.encryptedVideoId=F;m.cotn=L?.cotn;m.offlineabilityFormatType=L?.maximumDownloadQuality;m.isRefresh=L?.isRefresh??!1;m.softErrorCount=L?.transferRetryCount??0;m.offlineModeType=u??"OFFLINE_NOW";(m.transferStatusType==="TRANSFER_STATUS_TYPE_UNKNOWN"&&m.statusType==="UNKNOWN_STATUS_TYPE"||!m.transferStatusType&&!m.statusType)&&g.x2(Error("Woffle unknown transfer status"));g.RT("offlineTransferStatusChanged",m)},WoZ=function(m,F,L,u){u={transferStatusType:"TRANSFER_STATUS_TYPE_PROCESSING",
statusType:"OFFLINING_STARTED",transferFirstStarted:!!u};F&&L&&(F=Math.floor(F/1024).toFixed(),L=Math.floor(L/1024).toFixed(),u.alreadyDownloadedKbytes=F,u.totalFetchedKbytes=F,u.totalContentKbytes=L);BU(u,m)},OGq=function(m){BU({transferStatusType:"TRANSFER_STATUS_TYPE_DEQUEUED_BY_USER_PAUSE",
statusType:"SUSPENDED"},m)},Qu8=function(m){switch(m){case "TRANSFER_FAILURE_REASON_FILESYSTEM_WRITE":case "TRANSFER_FAILURE_REASON_EXTERNAL_FILESYSTEM_WRITE":return"OFFLINE_DATABASE_ERROR";
case "TRANSFER_FAILURE_REASON_PLAYABILITY":return"NOT_PLAYABLE";case "TRANSFER_FAILURE_REASON_TOO_MANY_RETRIES":return"TOO_MANY_RETRIES";case "TRANSFER_FAILURE_REASON_INTERNAL":return"OFFLINE_DOWNLOAD_CONTROLLER_ERROR";case "TRANSFER_FAILURE_REASON_STREAM_MISSING":return"STREAM_VERIFICATION_FAILED";case "TRANSFER_FAILURE_REASON_SERVER":case "TRANSFER_FAILURE_REASON_SERVER_PROPERTY_MISSING":return"OFFLINE_REQUEST_FAILURE";case "TRANSFER_FAILURE_REASON_NETWORK":return"OFFLINE_NETWORK_ERROR";default:return"UNKNOWN_FAILURE_REASON"}},
HU=function(m){return(m.actionMetadata?.retryScheduleIntervalsInSeconds?.length??0)>0},JD=function(m){return m.actionType==="OFFLINE_ORCHESTRATION_ACTION_TYPE_ADD"&&!!m.entityKey},C6=function(m){return m.actionType==="OFFLINE_ORCHESTRATION_ACTION_TYPE_REFRESH"&&!!m.entityKey},mG=function(m){return m.actionType==="OFFLINE_ORCHESTRATION_ACTION_TYPE_DELETE"&&!!m.entityKey},suG=function(m){return m.actionType==="OFFLINE_ORCHESTRATION_ACTION_TYPE_UPDATE"&&!!m.entityKey},Fo=async function(m,F,L,u,q=!1){const A=
g.dD(m,F),r=g.dD(m,"downloadStatusEntity");
m=await ME(L,{mode:"readonly",JW:!0},G=>g.hW.all([aA(G,A,F),aA(G,r,"downloadStatusEntity")]));
const y=m.length?m[0]:void 0;if(y){let G=m.length>1?m[1]:void 0;if(G){if(G.downloadState==="DOWNLOAD_STATE_USER_DELETED"&&!q)return;G.downloadState=u}else G={key:r,downloadState:u};g.Xc(y,bGG,G);await ME(L,{mode:"readwrite",JW:!0},v=>g.hW.all([p6(v,y,F),p6(v,G,"downloadStatusEntity")]))}},LZ=function(m,F){return m.actionType===F.actionType&&m.entityKey===F.entityKey},uX=function(m,F){if(m&&m.transferState!=="TRANSFER_STATE_COMPLETE"&&m.transferState!=="TRANSFER_STATE_FAILED"){const L=g.cf(m.key).entityId;
BU({transferStatusType:"TRANSFER_STATUS_TYPE_TERMINATED_BY_USER",statusType:"CANCELLED"},{videoId:L,cM:m,offlineModeType:F})}},qw=function(m){if(!m||!m.thumbnails)return[];
const F=[];for(const L of m.thumbnails)L.url&&F.push(L.url);return F},A3=async function(m,F,L=[]){if(!L.length)return[];
F=await Xu(m,F);m=new Set;for(var u of F)if(F=u.id||u.key)F=g.cf(F).entityId,m.add(F);u=[];for(const q of L)L=q.offlineVideoData,L?.videoId&&!m.has(L.videoId)&&u.push(q);return u},r5=function(m,F,L){return new g.I4(m,{cotn:F,
raw_player_response:L,download_media:!0,start:Infinity,disable_watch_next:!0})},yp=function(){return{priority:1,
retryScheduleIntervalsInSeconds:[1,2,4]}},vb=function(m){if(!m.key)throw Error("Entity key is required.");
if(!m.actionProto)throw Error("OfflineOrchestrationAction is required.");const F=g.cf(m.key),L=g.cf(m.actionProto.entityKey);return new GQ(L.entityType,F.entityId,m.actionProto,m.parentActionId,m.rootActionId,m.childActionIds,m.prereqActionId,m.postreqActionIds,m.retryScheduleIndex,m.hasChildActionFailed,Number(m.enqueueTimeSec)*1E3)},lX=function(m){return{key:g.dD(m.actionId,"offlineOrchestrationActionWrapperEntity"),
actionProto:m.action,parentActionId:m.parentActionId,rootActionId:m.rootActionId,childActionIds:m.childActionIds,prereqActionId:m.prereqActionId,postreqActionIds:m.postreqActionIds,retryScheduleIndex:m.retryScheduleIndex,hasChildActionFailed:m.hasChildActionFailed,enqueueTimeSec:(m.X/1E3).toFixed()}},cac=async function(){const m=await sT();
return m?m.delete("yt-player-local-img"):!0},w5=async function(m){const F=await sT();
if(!F)throw Error("Cache API not supported");if(m.length){var L=await F.open("yt-player-local-img");await Promise.all(m.map(u=>L.delete(u)))}},Vp=async function(m){const F=await sT();
if(!F)throw Error("Cache API not supported");m.length&&await (await F.open("yt-player-local-img")).addAll(m)},j$=async function(m,F,L,u,q){const A=g.dD(m,"mainVideoEntity"),r=g.dD(m,"ytMainChannelEntity"),y=g.dD(m,"transfer"),G=g.dD(m,"videoDownloadContextEntity");
var v=await ME(F,{mode:"readonly",JW:!0},t=>g.hW.all([aA(t,A,"mainVideoEntity"),aA(t,r,"ytMainChannelEntity"),aA(t,y,"transfer"),aA(t,G,"videoDownloadContextEntity"),D7(t,"ytMainChannelEntity"),D7(t,"offlineOrchestrationActionWrapperEntity")]));
const [l,w,V,I,P,N]=v;if(l||w){v=l?qw(l.thumbnail):[];var x=w?await d1e(w,P):[];await w5(v.concat(x))}const X=[],M=g.dD(m,"downloadStatusEntity");for(const t of N)v=g.cf(t.key).entityId,x=vb(t),x=g.cf(x.action.entityKey).entityId,v!==m&&x!==m||LZ(L,t.actionProto)||X.push(t.key);await ME(F,{mode:"readwrite",JW:!0},t=>{const h=X.map(qb=>f6(t,qb));
h.push(f6(t,A,{xZ:!0}));h.push(f6(t,M,{xZ:!0}));return g.hW.all(h)});
m=I?.offlineModeType;q&&(n6(q),q.offlineModeType&&(m=q.offlineModeType));uX(V,m);cU(u,{entityKey:A,failureReason:"OFFLINE_OPERATION_FAILURE_REASON_VIDEO_DELETED"})},I5=async function(m,F,L,u){const q=g.dD(m,"mainPlaylistEntity"),A=g.dD(m,"ytMainChannelEntity");
var r=await ME(F,{mode:"readonly",JW:!0},t=>g.hW.all([aA(t,q,"mainPlaylistEntity"),aA(t,A,"ytMainChannelEntity"),D7(t,"mainPlaylistEntity"),D7(t,"mainDownloadsListEntity"),D7(t,"ytMainChannelEntity"),D7(t,"offlineOrchestrationActionWrapperEntity")]));
const [y,G,v,l,w,V]=r;if(y||G){r=y?nqm(y):[];var I=G?await d1e(G,w):[];await w5(r.concat(I))}r=[];I=new Map;if(y){r=await BeC(y,v,l);for(var P of r)I.set(P,{videoId:P,playlistId:m,offlineDeleteReason:"OFFLINE_DELETE_REASON_PARENT_LIST_DELETE"});P=await ME(F,{mode:"readonly",JW:!0},qb=>g.hW.all([D7(qb,"transfer"),D7(qb,"videoDownloadContextEntity")]));
const [t,h]=P;for(var N of t)P=g.cf(N.key).entityId,(P=I.get(P))&&N&&(P.cotn=N.cotn);for(var x of h)N=g.cf(x.key).entityId,(N=I.get(N))&&x&&(N.offlineModeType=x.offlineModeType)}const X=[];for(const t of V)x=g.cf(t.key).entityId,N=vb(t),x!==m&&N.rootActionId!==m||LZ(L,t.actionProto)||X.push(t.key);const M=g.dD(m,"mainPlaylistEntity");await ME(F,{mode:"readwrite",JW:!0},t=>{const h=X.map(qb=>f6(t,qb));
h.push(f6(t,M,{xZ:!0}));return g.hW.all(h)});
if(y&&(r.reverse(),r))for(const t of r)await j$(t,F,L,u,I.get(t))},R5=async function(m,F,L,u){const q=g.dD("DOWNLOADS_LIST_ENTITY_ID_MANUAL_DOWNLOADS","mainDownloadsListEntity"),A=new Map;
m=await ME(m,{mode:"readwrite",JW:!0},r=>{const y=D7(r,"transfer"),G=D7(r,"offlineOrchestrationActionWrapperEntity"),v=D7(r,"videoDownloadContextEntity"),l=aA(r,q,"mainDownloadsListEntity");return g.hW.all([y,G,v,l]).then(([w,V,I,P])=>{const N=HGc.map(x=>xV(r,x));
for(const x of V)LZ(F,x.actionProto)||N.push(f6(r,x.key,{xZ:!0}));P&&(P.downloads=[],N.push(p6(r,P,"mainDownloadsListEntity")));if(I)for(const x of I)V=g.cf(x.key).entityId,V=g.dD(V,"transfer"),A.set(V,x.offlineModeType);return g.hW.all(N).then(()=>w)})});
for(const r of m){uX(r,A.get(r.key));m=g.cf(r.key).entityId;const y={videoId:m,offlineDeleteReason:u,cotn:r.cotn,offlineModeType:A.get(r.key)};n6(y);m=g.dD(m,"mainVideoEntity");cU(L,{entityKey:m,failureReason:"OFFLINE_OPERATION_FAILURE_REASON_VIDEO_DELETED"})}await cac()},nqm=function(m,F){let L=[];
if(m.thumbnailStyleData)for(const u of m.thumbnailStyleData)L=L.concat(qw(u?.value?.collageThumbnail?.coverThumbnail));m=qw(F);return L.concat(m)},BeC=async function(m,F,L){const u=[],q=new Set;
if(L.length)for(var A of L)if(A.downloads?.length)for(const r of A.downloads)r.videoItem&&(L=g.cf(r.videoItem).entityId,q.add(L));if(m.videos){for(const r of m.videos)A=JSON.parse(g.cf(r).entityId),A.videoId&&!q.has(A.videoId)&&u.push(A.videoId);for(const r of F)if(r.key!==m.key&&(F=r.videos))for(const y of F)F=JSON.parse(g.cf(y).entityId),F.videoId&&(F=u.indexOf(F.videoId),F!==-1&&u.splice(F,1))}return u},d1e=async function(m,F){const L=qw(m.avatar);
for(const u of F)if(u.id!==m.id)for(const q of qw(u.avatar))F=L.indexOf(q),F!==-1&&L.splice(F,1);return L},Jaf=async function(m){const F=g.p(m.frameworkUpdates,$l);
m.frameworkUpdates&&F&&await UT(F)},muG=function(m){if(m.onResponseReceivedActions?.length&&(m=g.p(g.p(m.onResponseReceivedActions[0],CmN),g.squ)?.actions,m?.length))return m},FQt=async function(m){if(!m)return[];
m=await oA(m,g.Ox,"mainDownloadsListEntity");return m?.downloads?.length?m.downloads.map(F=>F.videoItem??""):[]},e$=async function(m,F){const L=await LQe(m,F);
L&&await ME(m,{mode:"readwrite",JW:!0},u=>{const q=[p6(u,L.mainDownloadsLibraryEntity,"mainDownloadsLibraryEntity")];L.mainDownloadsListEntity&&q.push(p6(u,L.mainDownloadsListEntity,"mainDownloadsListEntity"));return g.hW.all(q)})},LQe=async function(m,F){const L=g.dD("main_downloads_library_id","mainDownloadsLibraryEntity"),u=g.dD("DOWNLOADS_LIST_ENTITY_ID_MANUAL_DOWNLOADS","mainDownloadsListEntity");
m=await ME(m,{mode:"readonly",JW:!0},G=>g.hW.all([aA(G,L,"mainDownloadsLibraryEntity"),aA(G,u,"mainDownloadsListEntity")]));
let [q,A]=m;m=q;let r=A;m||(m={id:L});for(const G of F)if(G===g.Ox){if(m.smartDownloadsList)return;m.smartDownloadsList=G}else{var y=g.cf(G).entityType;F={};y==="mainPlaylistEntity"?F.playlistItem=G:y==="mainVideoEntity"&&(F.videoItem=G);if(!g.qT(F)){if(r?.downloads){y=!1;for(const v of r.downloads)if(v.playlistItem===G||v.videoItem===G){y=!0;break}y||r.downloads.push(F)}else r={id:u,downloads:[F]};m.downloadsList=u}}return{mainDownloadsLibraryEntity:m,mainDownloadsListEntity:r}},Pb=async function(m,
F){const L=g.dD("main_downloads_library_id","mainDownloadsLibraryEntity"),u=g.dD("DOWNLOADS_LIST_ENTITY_ID_MANUAL_DOWNLOADS","mainDownloadsListEntity");
var q=await ME(m,{mode:"readonly",JW:!0},G=>g.hW.all([aA(G,L,"mainDownloadsLibraryEntity"),aA(G,u,"mainDownloadsListEntity"),aA(G,g.Ox,"mainDownloadsListEntity")]));
const [A,r,y]=q;if(A){if(F===g.Ox&&y?.downloads)y.downloads=[];else if(r?.downloads){q=g.cf(F).entityType;for(let G=0;G<r.downloads.length;G++){const v=r.downloads[G];if(q==="mainVideoEntity"&&v.videoItem===F){r.downloads.splice(G,1);break}else if(q==="mainPlaylistEntity"&&v.playlistItem===F){r.downloads.splice(G,1);break}}}await ME(m,{mode:"readwrite",JW:!0},G=>{const v=[p6(G,A,"mainDownloadsLibraryEntity")];r&&v.push(p6(G,r,"mainDownloadsListEntity"));y&&v.push(p6(G,y,"mainDownloadsListEntity"));
return g.hW.all(v)})}},iX=async function(m,F){const L=g.dD(F,"transfer"),u=g.dD(F,"videoDownloadContextEntity");
m=await ME(m,{mode:"readonly",JW:!0},r=>g.hW.all([aA(r,L,"transfer"),aA(r,u,"videoDownloadContextEntity")]));
const [q,A]=m;return{videoId:F,cotn:q?.cotn,offlineModeType:A?.offlineModeType}},g5=async function(m,F,L,u,q){const A=g.dD(m,"musicTrack"),r=g.dD(m,"transfer");
var y=await ME(F,{mode:"readonly",JW:!0},P=>g.hW.all([aA(P,A,"musicTrack"),aA(P,r,"transfer"),D7(P,"musicTrack"),D7(P,"offlineOrchestrationActionWrapperEntity")]));
const [G,v,l,w]=y;G&&(y=await uDq(G,l),await w5(y));const V=[];for(const P of w){y=g.cf(P.key).entityId;var I=vb(P);I=g.cf(I.action.entityKey).entityId;y!==m&&I!==m||LZ(L,P.actionProto)||V.push(P.key)}await ME(F,{mode:"readwrite",JW:!0},P=>{const N=V.map(x=>f6(P,x));
N.push(f6(P,A,{xZ:!0}));return g.hW.all(N)});
uX(v);q&&n6(q);cU(u,{entityKey:A,failureReason:"OFFLINE_OPERATION_FAILURE_REASON_VIDEO_DELETED"})},zQ=async function(m,F,L,u,q){const A=g.dD(m,F),r=g.dD("music_downloads_library_id","musicDownloadsLibraryEntity");
var y=await ME(L,{mode:"readonly",JW:!0},X=>g.hW.all([aA(X,A,F),aA(X,r,"musicDownloadsLibraryEntity"),D7(X,F),D7(X,"offlineOrchestrationActionWrapperEntity")]));
const [G,v,l,w]=y;G&&(y=await uDq(G,l),await w5(y));let V=[];y=new Map;if(G){V=await qGC(G,l,v);for(var I of V){const X=g.cf(I).entityId;y.set(X,{videoId:X,playlistId:m,offlineDeleteReason:"OFFLINE_DELETE_REASON_PARENT_LIST_DELETE"})}I=await Xu(L,"transfer");for(var P of I)I=g.cf(P.key).entityId,(I=y.get(I))&&P&&(I.cotn=P.cotn)}const N=[];for(const X of w)P=g.cf(X.key).entityId,I=vb(X),P!==m&&I.rootActionId!==m||LZ(u,X.actionProto)||N.push(X.key);const x=g.dD(m,F);await ME(L,{mode:"readwrite",JW:!0},
X=>{const M=N.map(t=>f6(X,t));
M.push(f6(X,x,{xZ:!0}));return g.hW.all(M)});
if(G&&(V.reverse(),V.length))for(const X of V)(m=g.cf(X).entityId)&&await g5(m,L,u,q,y.get(m))},Yl=async function(m,F,L){m=await ME(m,{mode:"readwrite",
JW:!0},u=>{const q=D7(u,"transfer"),A=D7(u,"offlineOrchestrationActionWrapperEntity");return g.hW.all([q,A]).then(([r,y])=>{const G=AuC.map(v=>xV(u,v));
for(const v of y){y=g.cf(v.actionProto.entityKey).entityType==="musicTrack";const l=v.actionProto.actionType==="OFFLINE_ORCHESTRATION_ACTION_TYPE_ADD";LZ(F,v.actionProto)||y&&(!y||l)||G.push(f6(u,v.key,{xZ:!0}))}return g.hW.all(G).then(()=>r)})});
for(const u of m)uX(u),m=g.cf(u.key).entityId,n6({videoId:m,offlineDeleteReason:void 0,cotn:u.cotn}),m=g.dD(m,"musicTrack"),cU(L,{entityKey:m,failureReason:"OFFLINE_OPERATION_FAILURE_REASON_VIDEO_DELETED"});await cac()},ruN=function(m){let F;
for(const L of m.additionalMetadatas)L.offlineMusicVideoData&&(F=L.offlineMusicVideoData);return{id:g.dD(m.videoId,"musicTrack"),videoId:m.videoId,title:m.title,thumbnailDetails:m.thumbnail,lengthMs:String(Number(m.lengthSeconds)*1E3),albumTitle:F?.releaseTitle,musicVideoType:F?.musicVideoType,contentRating:{explicitType:F?.explicitType},artistNames:F?.byline||F?.channelName,downloadMetadata:g.dD(m.videoId,"musicTrackDownloadMetadataEntity")}},qGC=async function(m,F,L){const u=[],q=new Set;
if(L?.downloadedTracks?.length)for(const A of L.downloadedTracks)q.add(A);if(m.tracks){for(const A of m.tracks)q.has(A)||u.push(A);for(const A of F)if(A.id!==m.id&&(F=A.tracks))for(const r of F)F=u.indexOf(r),F!==-1&&u.splice(F,1)}return u},uDq=async function(m,F){const L=qw(m.thumbnailDetails);
for(const u of F)if(u.id!==m.id)for(const q of qw(u.thumbnailDetails))F=L.indexOf(q),F!==-1&&L.splice(F,1);return L},a5=async function(m,F){var L=g.dD("music_downloads_library_id","musicDownloadsLibraryEntity");
let u=await oA(m,L,"musicDownloadsLibraryEntity");u||(u={id:L});L=g.cf(F).entityType;L==="musicTrack"?u.downloadedTracks?.includes(F)||(u.downloadedTracks=(u.downloadedTracks??[]).concat(F)):L==="musicPlaylist"?u.downloadedPlaylists?.includes(F)||(u.downloadedPlaylists=(u.downloadedPlaylists??[]).concat(F)):L!=="musicAlbumRelease"||u.downloadedAlbumReleases?.includes(F)||(u.downloadedAlbumReleases=(u.downloadedAlbumReleases??[]).concat(F));await Z7(m,u,"musicDownloadsLibraryEntity")},DQ=async function(m,
F){var L=g.dD("music_downloads_library_id","musicDownloadsLibraryEntity");
if(L=await oA(m,L,"musicDownloadsLibraryEntity")){var u=g.cf(F).entityType;let q;u==="musicTrack"?q=L.downloadedTracks:u==="musicPlaylist"&&(q=L.downloadedPlaylists);if(q?.length)for(u=0;u<q.length;u++)if(q[u]===F){q.splice(u,1);break}await Z7(m,L,"musicDownloadsLibraryEntity")}},yuf=function(m){var F=m.videos;
m=[];const L=[];if(F)for(const q of F){var u=q.offlineVideoData.videoId;F=g.dD(u,"musicTrack");u=g.dD(u,"musicTrackDownloadMetadataEntity");m.push(F);L.push(u)}return{Uo:m,e6:L}},TQ=function(m,F,L){F={track:ruN(F)};
L&&(F.playlistId=L);if(m=g.p(m.actionMetadata,GaC))F.maximumDownloadQuality=m.maximumDownloadQuality;return{musicTrackEntityActionMetadata:F}},l28=async function(m){var F=g.Cu();
m=D1c(m);const L=g.rN(v6C);try{var u=await g.B9(F,m,L,void 0,{tY:!0})}catch(q){if(q instanceof g.WJ)throw u=`GetOffline network manager error: ${q.message}`,b_(u,q),Error(u);b_("GetOffline fetch request error",q);throw Error("GetOffline fetch request error");}F=u.errorMetadata?.status;if(!u)throw b_("Network request failed"),Error("Network request failed");if(F!==void 0)Nw(F);else if(!u.videos||!u.videos.length)throw b_("No data"),Error("No data");return u.videos.map(q=>q.offlineVideoData)},pZ=async function(m){var F=
g.Cu();
m=Tet(m);const L=g.rN(v6C);try{var u=await g.B9(F,m,L,void 0,{tY:!0})}catch(q){if(q instanceof g.WJ)throw u=`GetOffline network manager error for playlist: ${q.message}`,b_(u,q),Error(u);b_("GetOffline fetch request error for playlist",q);throw Error("GetOffline fetch request error for playlist");}F=u.errorMetadata?.status;if(!u)throw b_("Network request failed for playlist"),Error("Network request failed for playlist");if(F!==void 0)Nw(F,"playlist");else if(!u.playlists||!u.playlists.length)throw b_("No data for playlist"),
Error("No data for playlist");return u.playlists.map(q=>q.offlinePlaylistData)},Vvc=async function(m,F,L,u){const q=await ET();
if(!q)return[];var A=[];u?.length?A=u:A=await Xu(q,"mainPlaylistEntity");if(!A.length)return[];u=[];const r=Date.now()/1E3;for(const l of A){var y=l.downloadState?await oA(q,l.downloadState,"mainPlaylistDownloadStateEntity"):void 0,G=(A=l?.entityMetadata)&&A.nextAutoRefreshIntervalSeconds?Number(A.nextAutoRefreshIntervalSeconds):NaN;G=Number.isNaN(G)?m:G;var v=y?.lastSyncedTimestampMillis?Number(y?.lastSyncedTimestampMillis)/1E3:0;y=y?.addedTimestampMillis?Number(y?.addedTimestampMillis)/1E3:0;if(L||
!A||v+G<=r){G=[];if(l.videos?.length)for(const w of l.videos)v=JSON.parse(g.cf(w).entityId),v.videoId&&G.push(v.videoId);v="0";A&&(v=String(Number(A.offlineLastModifiedTimestampSeconds??0).toFixed()));u.push({playlistId:l.playlistId,videoIds:G,offlineLastModifiedTimestamp:v,autoSync:F,offlineDateAddedTimestamp:String(y.toFixed())})}}return u.length?await wHG(u):[]},jcf=async function(){var m=await ET();
if(!m)return!1;m=await Xu(m,"refresh");if(!m[0]?.refreshTime)return!1;m=Number(m[0].refreshTime);const F=Date.now()/1E3;return isFinite(m)&&F>=m},R7C=async function(m,F){let L;
try{const u=await I22(m,F);await Jaf(u);L=muG(u)}catch(u){b_("getAndProcessSmartDownloadsResponse request or processing error",u)}return L},$uZ=async function(m,F,L,u){const q=await ET();
if(!q)return[];var A=[];u?.length?A=u:A=await Xu(q,"musicPlaylist");if(!A.length)return[];u=[];const r=Date.now()/1E3;for(const v of A){var y=(A=v?.entityMetadata)&&A.nextAutoRefreshIntervalSeconds?Number(A.nextAutoRefreshIntervalSeconds):NaN;const l=Number.isNaN(y)?m:y;let w=y=0;var G="DOWNLOAD_SYNC_STATE_UNKNOWN";v.downloadMetadata&&(G=await oA(q,v.downloadMetadata,"musicPlaylistDownloadMetadataEntity"),y=Number(G?.addedTimestampMillis??"0")/1E3,w=Number(G?.lastModifiedTimestampMillis??"0")/1E3,
G=G?.syncState??"DOWNLOAD_SYNC_STATE_UNKNOWN");if(L||G!=="DOWNLOAD_SYNC_STATE_UP_TO_DATE"||!A||Number(A.lastSyncedTimestampSeconds??0)+l<=r){A=[];if(v.tracks?.length)for(const V of v.tracks)A.push(g.cf(V).entityId);u.push({playlistId:v.playlistId,videoIds:A,offlineLastModifiedTimestamp:String(w.toFixed()),autoSync:F,offlineDateAddedTimestamp:String(y.toFixed())})}}return u.length?await wHG(u):[]},I22=async function(m,F){var L=g.Cu(),u=await ET();
let q;u&&(q=await M_R(u));u=q;m={context:g.q$(),browseId:"FEdownloads",browseRequestSupportedMetadata:{downloadsBrowseParams:{offlineFeatureSettingState:{isSdEnabled:m},offlineClientState:u,clientStateRequestData:{preferredFormatType:F}}}};F=g.rN(e7t);try{var A=await g.B9(L,m,F,void 0,{tY:!0})}catch(r){if(r instanceof g.WJ)throw A=`DPS network manager error for smart downloads: ${r.message}`,b_(A,r),Error(A);b_("DPS fetch request error for smart downloads",r);throw Error("DPS fetch request error for smart downloads");
}L=A.errorMetadata?.status;if(A)L!==void 0&&Nw(L,"smart downloads");else throw b_("Network request failed for smart downloads"),Error("Network request failed for smart downloads");return A},iY2=async function(m,F){var L=g.Cu();
m={context:g.q$(),videoPlaybackPositionEntities:m,lastSyncTimestampUsec:F};F=g.rN(PbC);try{var u=await g.B9(L,m,F,void 0,{tY:!0})}catch(q){if(q instanceof g.WJ)throw u=`VPPS network manager error: ${q.message}`,b_(u,q),Error(u);b_("VPPS fetch request error",q);throw Error("VPPS fetch request error");}L=u.errorMetadata?.status;if(u)L!==void 0&&Nw(L,"position sync");else throw b_("Network request failed for position sync"),Error("Network request failed for position sync");return u},z7C=async function(m,
F,L){var u=g.Cu(),q=L.refreshData,A=L.isEnqueuedForExpiredStreamUrlRefetch,r=L.PT,y=L.offlineSourceData;
L=L.mediaCapabilities;m={entityKey:m};q&&(m.refreshData=q);A&&(m.isExpiredStreamUrlRefetch=A);r&&(m.downloadParameters=r);y&&(m.offlineSourceData=y);F={context:g.OP(F),signatureTimestamp:20458,videos:[m]};L&&(F.mediaCapabilities=L);q=g.rN(g6C);try{var G=await g.B9(u,F,q,void 0,{tY:!0})}catch(v){if(v instanceof g.WJ)throw G=`GetPDE network manager error: ${v.message}`,b_(G,v),Error(G);b_("GetPDE fetch request error",v);throw Error("GetPDE fetch request error");}u=G.errorMetadata?.status;if(G)u!==void 0&&
Nw(u,"PDE");else throw b_("Network request failed for PDE"),Error("Network request failed for PDE");return G},Nw=function(m,F){F=F?` for ${F}`:"";
if(m===0)throw m=`Empty response body${F}`,b_(m),Error(m);m=`Response with error${F}`;b_(m);throw Error(m);},wHG=async function(m){var F=g.Cu();
m=Nee(m);const L=g.rN(YGe);try{var u=await g.B9(F,m,L,void 0,{tY:!0})}catch(q){if(q instanceof g.WJ)throw u=`offlinePlaylistSyncCheck network manager error: ${q.message}`,b_(u,q),Error(u);b_("offlinePlaylistSyncCheck fetch request error",q);throw Error("offlinePlaylistSyncCheck fetch request error");}F=u.errorMetadata?.status;if(!u)throw b_("Network request failed for playlist sync"),Error("Network request failed for playlist sync");if(F!==void 0)Nw(F,"playlist sync");else if(!u.offlinePlaylistSyncCheckDatas||
!u.offlinePlaylistSyncCheckDatas.length)throw b_("No data for playlist sync"),Error("No data for playlist sync");return u.offlinePlaylistSyncCheckDatas.map(q=>q.offlinePlaylistSyncCheckData)},a2e=async function(m,F){const L=new Map;
for(const u of F)L.set(u,await m.B(u));return L},KZ=function(m,F,L,u,q,A){F=g.dD(F,L);
return{actionType:m,entityKey:F,actionMetadata:{...A,priority:u,retryScheduleIntervalsInSeconds:q}}},NuG=async function(m,F){var L=F.entityKey;
const u=g.p(F.actionMetadata,fZ)?.isEnqueuedForExpiredStreamUrlRefetch;try{let A=void 0;A=await DuZ(m,F);let r;try{{const y=g.p(F.actionMetadata,fZ);var q=y?{maximumDownloadQuality:y.maximumDownloadQuality}:void 0}r=await z7C(L,m.S,{isEnqueuedForExpiredStreamUrlRefetch:u,PT:q,offlineSourceData:A})}catch(y){const G=HU(F)?"OFFLINE_ORCHESTRATION_FAILURE_REASON_RECOVERABLE_NETWORK_ERROR":"OFFLINE_ORCHESTRATION_FAILURE_REASON_UNRECOVERABLE_NETWORK_ERROR";b_("PDE handleAdd error");return xl(F,!1,void 0,
"OFFLINE_OPERATION_FAILURE_REASON_NETWORK_REQUEST_FAILED",G,"DOWNLOAD_STATE_FAILED")}await TuC(m,r,F);return xl(F,!0,r.orchestrationActions)}catch(A){return m="OFFLINE_OPERATION_FAILURE_REASON_UNKNOWN",L="OFFLINE_ORCHESTRATION_FAILURE_REASON_DATABASE_OPERATION_FAILED",A instanceof g.Xa&&A.type==="QUOTA_EXCEEDED"&&(m="OFFLINE_OPERATION_FAILURE_REASON_DATABASE_REQUEST_FAILED",L="OFFLINE_ORCHESTRATION_FAILURE_REASON_NO_STORAGE"),b_("PDE handleAdd error"),xl(F,!1,void 0,m,L,"DOWNLOAD_STATE_FAILED")}},
f28=async function(m,F){const L=F.entityKey,u=g.cf(L).entityId;
var q=await ME(m.X,{mode:"readonly",JW:!0},w=>{const V=aA(w,L,"playbackData"),I=aA(w,g.dD(u,"offlineVideoPolicy"),"offlineVideoPolicy");w=aA(w,g.dD(u,"transfer"),"transfer");return g.hW.all([V,I,w])});
const [A,r,y]=q;if(!A||!r)return xl(F,!0);q=[];var G=A?.playerResponseJson?JSON.parse(A.playerResponseJson):null;if(y&&G){var v=pH6(m,G,y);q=await KQe(m,y)}q={lastPlayerResponseTimestampSeconds:A.playerResponseTimestamp,offlineToken:r.offlineToken,formatIds:q};G={};y?.maximumDownloadQuality&&(G.maximumDownloadQuality=y.maximumDownloadQuality);try{let w=void 0;w=await DuZ(m,F);try{var l=await z7C(L,m.S,{refreshData:q,PT:G,offlineSourceData:w,mediaCapabilities:v})}catch(V){const I=HU(F)?"OFFLINE_ORCHESTRATION_FAILURE_REASON_RECOVERABLE_NETWORK_ERROR":
"OFFLINE_ORCHESTRATION_FAILURE_REASON_UNRECOVERABLE_NETWORK_ERROR";b_("PDE handleRefresh error");return xl(F,!1,void 0,"OFFLINE_OPERATION_FAILURE_REASON_NETWORK_REQUEST_FAILED",I,"DOWNLOAD_STATE_FAILED")}await TuC(m,l,F);return xl(F,!0,l.orchestrationActions)}catch(w){return m="PDE handleRefresh error",w instanceof Error&&(m=`PDE handleRefresh error: ${w.message}`),v="OFFLINE_OPERATION_FAILURE_REASON_UNKNOWN",l="OFFLINE_ORCHESTRATION_FAILURE_REASON_DATABASE_OPERATION_FAILED",w instanceof g.Xa&&w.type===
"QUOTA_EXCEEDED"&&(v="OFFLINE_OPERATION_FAILURE_REASON_DATABASE_REQUEST_FAILED",l="OFFLINE_ORCHESTRATION_FAILURE_REASON_NO_STORAGE"),b_(m),xl(F,!1,void 0,v,l,"DOWNLOAD_STATE_FAILED")}},DuZ=async function(m,F){F=g.cf(F.entityKey).entityId;
F=g.dD(F,"videoDownloadContextEntity");m=await oA(m.X,F,"videoDownloadContextEntity");return m?.offlineModeType?{offlineModeType:m.offlineModeType}:void 0},xl=function(m,F,L,u,q,A){return new Mw(F?"OFFLINE_ORCHESTRATION_ACTION_RESULT_SUCCESS":"OFFLINE_ORCHESTRATION_ACTION_RESULT_FAILURE",HU(m),L,u,q,A)},TuC=async function(m,F,L){if(F.frameworkUpdates&&g.p(F.frameworkUpdates,$l)){if(g.p(F.frameworkUpdates,$l).mutations&&g.p(F.frameworkUpdates,$l).mutations.length>0&&g.p(F.frameworkUpdates,$l).mutations[0].type===
"ENTITY_MUTATION_TYPE_DELETE"){const u=g.cf(g.p(F.frameworkUpdates,$l).mutations[0].entityKey).entityId,q=await iX(m.X,u),A=g.p(L.actionMetadata,fZ)?.playlistId;
A&&(q.playlistId=A);q.offlineDeleteReason="OFFLINE_DELETE_REASON_UNKNOWN";g.mm(m.S)?await j$(u,m.X,L,m.G,q):g.Qf(m.S)&&await g5(u,m.X,L,m.G)}await UT(g.p(F.frameworkUpdates,$l))}},pH6=function(m,F,L){F=r5(m.S,L.cotn,F);
L=g.Vi(F);return g.N2B(F,L,m.S)},KQe=async function(m,F){const L=[];
if(m=await ME(m.X,{mode:"readonly",JW:!0},u=>{const q=[],A=F.offlineVideoStreams;if(A)for(const r of A)q.push(aA(u,r,"offlineVideoStreams"));return g.hW.all(q)}))for(const u of m)if(u?.streamsProgress){m=u.streamsProgress;
for(let q=0;q<m.length;q++){const A=JSON.parse(m[q].formatStreamBytes);L.push({itag:A.itag,lmt:A.lastModified,xtags:A.xtags})}}return L},xuN=async function(m,F){F=HU(F);
m=await Xu(m.X,"videoPlaybackPositionEntity");if(m.length===0)return new Mw("OFFLINE_ORCHESTRATION_ACTION_RESULT_SUCCESS",F);try{const L=await ZQ.getInstance();if(!L)throw Error("prefStorage is undefined");const u=(await L.get("psi"))?.pZ??"0",q=await iY2(m,u),A={isPaused:q.watchHistoryPaused,pZ:q.syncTimestampUsec};await L.set("psi",A);if(!A.isPaused){const r=g.p(q.frameworkUpdates,$l);q.frameworkUpdates&&r&&await UT(r)}}catch(L){return b_("PPE handleRefresh error: "+(L instanceof Error?L.message:
"unknown error")),new Mw("OFFLINE_ORCHESTRATION_ACTION_RESULT_FAILURE",F,void 0,"OFFLINE_OPERATION_FAILURE_REASON_DATABASE_REQUEST_FAILED","OFFLINE_ORCHESTRATION_FAILURE_REASON_DATABASE_OPERATION_FAILED")}return new Mw("OFFLINE_ORCHESTRATION_ACTION_RESULT_SUCCESS",F)},ZYG=async function(m,F){const L=HU(F),u=g.cf(F.entityKey).entityId;
try{const q=await ZQ.getInstance();if(!q)throw Error("prefStorage is undefined");const A=await q.get("psi"),r=g.p(F.actionMetadata,MvC);if(A?.isPaused===!1&&r?.lastPlaybackPositionSeconds){const y={key:g.dD(u,"videoPlaybackPositionEntity"),videoId:u,lastPlaybackPositionSeconds:r.lastPlaybackPositionSeconds};await Z7(m.X,y,"videoPlaybackPositionEntity")}}catch(q){return new Mw("OFFLINE_ORCHESTRATION_ACTION_RESULT_FAILURE",L,void 0,"OFFLINE_OPERATION_FAILURE_REASON_DATABASE_REQUEST_FAILED","OFFLINE_ORCHESTRATION_FAILURE_REASON_DATABASE_OPERATION_FAILED")}return new Mw("OFFLINE_ORCHESTRATION_ACTION_RESULT_SUCCESS",
L)},SGC=async function(m,F){const L=HU(F);
try{const u=g.cf(F.entityKey).entityId;if(u==="!*$_ALL_ENTITIES_!*$")await whC(m.X);else{const q=g.dD(u,"videoPlaybackPositionEntity");await SF(m.X,q)}}catch(u){return new Mw("OFFLINE_ORCHESTRATION_ACTION_RESULT_FAILURE",L,void 0,"OFFLINE_OPERATION_FAILURE_REASON_UNKNOWN","OFFLINE_ORCHESTRATION_FAILURE_REASON_DATABASE_OPERATION_FAILED")}return new Mw("OFFLINE_ORCHESTRATION_ACTION_RESULT_SUCCESS",L)},S$=async function(m){return aXG(m)},o6R=async function(m){return(await g.FrD(m)).filter(F=>!!F.url).map(F=>
F.url)},o5=function(m,F){var L=g.or(F);
if(L===1||L===0)return Promise.resolve();(L=m.player?.getVideoData().videoId===F?m.player:null)&&L.stopVideo();m.G=0;return S$(F)},Xo=function(m,F,L=!1,u=!0){F=typeof F==="string"?F:F.videoDetails.videoId;
if(g.or(F)===2){var q=m.player?.getVideoData().videoId===F?m.player:null;q&&q.stopVideo();g.XO(F,2);m.G=2;L?XHR(m.X):u&&tvf(m.X)}},UuZ=async function(m,F){const L=HU(F);
if(await oA(m.X,F.entityKey,"transfer"))return new Mw("OFFLINE_ORCHESTRATION_ACTION_RESULT_SUCCESS",L);try{await E6f(m,F)}catch(u){return new Mw("OFFLINE_ORCHESTRATION_ACTION_RESULT_FAILURE",L,void 0,"OFFLINE_OPERATION_FAILURE_REASON_DATABASE_REQUEST_FAILED","OFFLINE_ORCHESTRATION_FAILURE_REASON_DATABASE_OPERATION_FAILED")}return new Mw("OFFLINE_ORCHESTRATION_ACTION_RESULT_SUCCESS",L)},kaf=async function(m,F){const L=HU(F),u=await oA(m.X,F.entityKey,"transfer");
if(!u||u.transferState!=="TRANSFER_STATE_COMPLETE")return new Mw("OFFLINE_ORCHESTRATION_ACTION_RESULT_SUCCESS",L);try{await E6f(m,F,!0)}catch(q){return new Mw("OFFLINE_ORCHESTRATION_ACTION_RESULT_FAILURE",L,void 0,"OFFLINE_OPERATION_FAILURE_REASON_DATABASE_REQUEST_FAILED","OFFLINE_ORCHESTRATION_FAILURE_REASON_DATABASE_OPERATION_FAILED")}return new Mw("OFFLINE_ORCHESTRATION_ACTION_RESULT_SUCCESS",L)},h7e=async function(m,F){const L=HU(F),u=g.cf(F.entityKey).entityId,q=await ME(m.X,{mode:"readonly",
JW:!0},y=>{const G=aA(y,F.entityKey,"transfer");y=aA(y,g.dD(u,"videoDownloadContextEntity"),"videoDownloadContextEntity");return g.hW.all([G,y])}),[A,
r]=q;if(!A||A.transferState!=="TRANSFER_STATE_WAITING_FOR_PLAYER_RESPONSE_REFRESH")return new Mw("OFFLINE_ORCHESTRATION_ACTION_RESULT_SUCCESS",L);try{A.transferState="TRANSFER_STATE_TRANSFER_IN_QUEUE";await Z7(m.X,A,"transfer");const y=g.cf(A.key).entityId;BU({transferStatusType:"TRANSFER_STATUS_TYPE_REENQUEUED_BY_PLAYER_RESPONSE_REFRESH"},{videoId:y,cM:A,offlineModeType:r?.offlineModeType})}catch(y){return new Mw("OFFLINE_ORCHESTRATION_ACTION_RESULT_FAILURE",L,void 0,"OFFLINE_OPERATION_FAILURE_REASON_DATABASE_REQUEST_FAILED",
"OFFLINE_ORCHESTRATION_FAILURE_REASON_DATABASE_OPERATION_FAILED")}return new Mw("OFFLINE_ORCHESTRATION_ACTION_RESULT_SUCCESS",L)},E6f=async function(m,F,L=!1){const u=g.p(F.actionMetadata,WQC),q=g.cf(F.entityKey).entityId,A=g.dD(q,"downloadStatusEntity");
var r=await ME(m.X,{mode:"readonly",JW:!0},l=>{const w=aA(l,A,"downloadStatusEntity");l=aA(l,g.dD(q,"videoDownloadContextEntity"),"videoDownloadContextEntity");return g.hW.all([w,l])});
const [y,G]=r;r="TRANSFER_STATE_TRANSFER_IN_QUEUE";y?.downloadState==="DOWNLOAD_STATE_USER_DELETED"&&(r="TRANSFER_STATE_PAUSED_BY_USER");const v={key:F.entityKey,transferState:r,cotn:g.$H(16),enqueuedTimestampMs:Date.now().toString(),maximumDownloadQuality:u?.maximumDownloadQuality,preferredAudioTrack:u?.preferredAudioTrack,transferRetryCount:0,isRefresh:L,hasLoggedFirstStarted:!1};await ME(m.X,{mode:"readwrite",JW:!0},l=>{const w=[];L&&w.push(f6(l,g.dD(q,"offlineVideoStreams")));w.push(p6(l,v,"transfer"));
return g.hW.all(w)});
L&&await S$(q);BU({transferStatusType:"TRANSFER_STATUS_TYPE_ENQUEUED",statusType:"ADDED_TO_QUEUE"},{videoId:q,cM:v,offlineModeType:G?.offlineModeType})},Qct=function(m,F,L,u){if(!m.action.entityKey)throw Error("entityKey is missing.");
const {b8:q,entityId:A}=g.cf(m.action.entityKey),r={entityType:q,entityId:A,offlineOrchestrationActionType:m.action.actionType,orchestrationAction:{orchestrationActionId:m.actionId}};F&&(r.offlineOrchestrationActionResult=F.status,r.isRetryable=L?!1:F.X,F.G&&(r.offlineOrchestrationFailureReason=OY8(F.G,r.isRetryable)));m.action.actionMetadata?.offlineLoggingData?.offlineModeType&&(r.offlineModeType=m.action.actionMetadata.offlineLoggingData.offlineModeType);u&&(r.additionalOrchestrationActions=u.map(y=>
({orchestrationActionId:y.actionId})));
return r},OY8=function(m,F){return m!=="OFFLINE_ORCHESTRATION_FAILURE_REASON_RECOVERABLE_NETWORK_ERROR"||F?m==="OFFLINE_ORCHESTRATION_FAILURE_REASON_UNRECOVERABLE_NETWORK_ERROR"&&F?"OFFLINE_ORCHESTRATION_FAILURE_REASON_RECOVERABLE_NETWORK_ERROR":m:"OFFLINE_ORCHESTRATION_FAILURE_REASON_UNRECOVERABLE_NETWORK_ERROR"},t3=function(m,F){const L={offlineOrchestrationContext:Qct(m)};
F=fXe(F,L);x1C(KoC(),F,m.rootActionId)},Ee=function(m,F,L,u=[]){F={offlineOrchestrationContext:Qct(m,F,L,u)};
F=fXe(3,F);x1C(KoC(),F,m.rootActionId)},sc8=function(m,F){for(const L of F)t3(L,1),m.actions.push(L);
m.actions.sort(m.X)},bY6=function(m,F){if(F)for(let L=0;L<m.actions.length;L++)if(F==="!*$_ALL_ENTITIES_!*$"&&m.actions[L].actionId!==F||F!=="!*$_ALL_ENTITIES_!*$"&&m.actions[L].rootActionId===F&&m.actions[L].actionId!==F)m.actions.splice(L,1),L--},cuq=function(m,F){for(const L of m.actions)if(L.actionId===F)return!0;
return!1},HYq=async function(m,F,L,u,q){m=new duq(m,F,L,u,q);
await n6Z(m);Bu8(m);return m},n6Z=async function(m){const F=await Xu(m.B,"offlineOrchestrationActionWrapperEntity");
await Ue(m,F)},Bu8=function(m){const F=m.X.actions[0];
return m.V?(F?.action.actionType==="OFFLINE_ORCHESTRATION_ACTION_TYPE_DELETE"&&m.V[0].action.actionType!=="OFFLINE_ORCHESTRATION_ACTION_TYPE_DELETE"&&(m.O=!0),Promise.resolve()):Juq(m)},Juq=async function(m){if(m.V)throw Error("Already processing an action");
if(!m.jY()){var F=m.X.actions.shift();kfR(m.XN,!F);if(F!==void 0){F.action.actionType==="OFFLINE_ORCHESTRATION_ACTION_TYPE_REFRESH"&&F.actionId==="DOWNLOADS_LIST_ENTITY_ID_SMART_DOWNLOADS"&&bY6(m.X,F.actionId);var L="";F.action.actionType==="OFFLINE_ORCHESTRATION_ACTION_TYPE_DELETE"&&F.rootActionId===F.actionId&&(L=F.actionId);var u=[F];m.V=u;if(F=m.hF[F.entityType]){for(const q of u)t3(q,2);try{const q=await a2e(F,u.map(A=>A.action));
for(const A of u){const r=q.get(A.action);await Cbc(m,A,r)}bY6(m.X,L)}catch(q){b_("Orchestration error",q);try{await mQC(m,u)}catch(A){b_("Orchestration retry error",A);for(const r of u)r.retryScheduleIndex<3&&sc8(m.X,[r])}}finally{m.V=void 0}}else m.V=void 0;await Juq(m)}}},Cbc=async function(m,F,L){var u=F.retryScheduleIndex+2===3;
if(L.status==="OFFLINE_ORCHESTRATION_ACTION_RESULT_SUCCESS"){var q=void 0;try{q=L.V?.map(A=>m.createAction(A,F))}catch(A){Ee(F,L,u);
cU(m.L,{entityKey:F.action.entityKey,failureReason:"OFFLINE_OPERATION_FAILURE_REASON_UNSUPPORTED_ENTITY_FAILED"});b_("Orchestration subactions creation error",A);return}Ee(F,L,u,q);if(q){const A=q.map(y=>lX(y));
let r=0;for(;r<q.length&&!m.O;)await ME(m.B,{mode:"readwrite",JW:!0},y=>{const G=[];G.push(K6(y,A.slice(r,r+10),"offlineOrchestrationActionWrapperEntity"));return g.hW.all(G)}),r+=10;
if(m.O){m.O=!1;return}}L=lX(F);await SF(m.B,L.key);t3(F,4)}else if(L.status==="OFFLINE_ORCHESTRATION_ACTION_RESULT_FAILURE")if(Ee(F,L,u),L.X&&F.retryScheduleIndex+1<3)await mQC(m,[F]);else{u={entityKey:F.action.entityKey,failureReason:L?.B?L.B:"OFFLINE_OPERATION_FAILURE_REASON_UNKNOWN"};q=void 0;g.mm(m.S)?q="mainVideoDownloadStateEntity":g.Qf(m.S)&&(q="musicTrackDownloadMetadataEntity");if(q&&L.downloadState){const A=g.cf(F.action.entityKey).entityId;await Fo(A,q,m.B,L.downloadState)}cU(m.L,u);L.downloadState===
"DOWNLOAD_STATE_FAILED"&&m.S.N("html5_auto_retry_failed_pde_actions")||(b_("Orchestration result is not retryable, deleting action"),await SF(m.B,lX(F).key))}},mQC=async function(m,F){for(const L of F){const u=L.action?.actionMetadata?.retryScheduleIntervalsInSeconds||[1,
2,4];let q=1;L.retryScheduleIndex<u.length&&(q=u[L.retryScheduleIndex]);L.X=q*1E3+Date.now();L.retryScheduleIndex++}await Fgt(m,F)},LgR=async function(m,F){return(await Xu(m.B,"offlineOrchestrationActionWrapperEntity",F)).filter(eS8)},Ue=async function(m,F){let L=[];
var u=Infinity;let q=4E3;for(const r of F){F=Number(r.enqueueTimeSec);const y=upe(F);var A=r.retryScheduleIndex;A=A!=null&&A>0;y>0&&A?(u=Math.min(u,F),q=Math.min(y,q)):L.push(r)}isFinite(u)&&(!m.G.isActive()||u<m.Z)&&(m.Z=u,m.G.start(q));m.j.X2()||(u=L.length,L=L.filter(r=>!qoe.includes(r.actionProto?.actionType||"OFFLINE_ORCHESTRATION_ACTION_TYPE_UNKNOWN")),u=L.length<u,!m.G.isActive()&&u&&m.G.start(1));
L.length>0&&ALG(m,L);await Bu8(m)},upe=function(m){m=m*1E3-Date.now();
return m>4E3?4E3:m},ALG=function(m,F){F.length!==0&&F.forEach(L=>{L=vb(L);
L.retryScheduleIndex<3&&sc8(m.X,[L])})},rLR=async function(m){var F=await LgR(m);
const L=[];for(const u of F)F=g.cf(u.key).entityId,cuq(m.X,F)||L.push(u);await Ue(m,L)},Fgt=function(m,F){if(F.length===0)return Promise.resolve([]);
F=F.map(L=>lX(L));
return lX6(m.B,F)},yLC=async function(m,F){const L=F.videoId;
let u=!0;if(F.captionTracks.length){const q=bmZ(F);m.X=new g.YR(m.w8,F,q)}else if(F.Ou)m.X=new g.aq(m.w8,F.Ou,L,g.PzB(F),F.Qg,F.eventId),u=F.Qg;else return;return new Promise(q=>{m.X?.O({SJ:async()=>{await m.SJ(L,u);q()},
Q7:()=>{}})})},G$8=async function(m){m=await Yi8(m);
return!!m&&m.length>0},vnm=async function(m,F){if(F.length===0)return[];
const L=F.map(q=>g.dD(q,"transfer")),u=(await Xu(m.X,"transfer",L)).filter(eS8).map(q=>g.cf(q.key).entityId);
m=F.filter(q=>u.indexOf(q)===-1);
if(m.length===0)return[];for(const q of m)await S$(q);return m},VgN=async function(m,F,L,u,q,A){let r="STREAM_TYPE_UNKNOWN";
L.video&&L.audio?(r="STREAM_TYPE_AUDIO_AND_VIDEO",b_("unexpected stream type")):L.video&&!L.audio?r="STREAM_TYPE_VIDEO":!L.video&&L.audio&&(r="STREAM_TYPE_AUDIO");const y=g.dD(F,"offlineVideoStreams"),G={numBytesDownloaded:q.toFixed(),numTotalBytes:A.toFixed(),streamType:r,streamState:"DOWNLOAD_STREAM_STATE_IN_PROGRESS",formatStreamBytes:JSON.stringify(u),itag:r==="STREAM_TYPE_AUDIO_AND_VIDEO"?Number(L.itag):void 0};await ME(m,{mode:"readwrite",JW:!0},v=>{const l=aA(v,y,"offlineVideoStreams"),w=aA(v,
g.dD(F,"transfer"),"transfer");return g.hW.all([l,w]).then(([V,I])=>{if(!I)return f6(v,y).then(()=>{});
var P=lke(V);V=wyZ(V,u,G,y);const N=p6(v,V,"offlineVideoStreams");lke(V)>P&&(I.lastProgressTimeMs=Date.now().toString());P=[N];I.offlineVideoStreams||(I.offlineVideoStreams=[]);I.offlineVideoStreams.indexOf(y)===-1&&(I.offlineVideoStreams.push(y),P.push(p6(v,I,"transfer")));return g.hW.all(P)})})},j$q=async function(m,F){F=g.dD(F,"offlineVideoStreams");
if((F=await oA(m,F,"offlineVideoStreams"))&&F.streamsProgress){for(const L of F.streamsProgress)L.streamState="DOWNLOAD_STREAM_STATE_COMPLETE",L.numTotalBytes!==L.numBytesDownloaded&&(L.numBytesDownloaded=L.numTotalBytes);await Z7(m,F,"offlineVideoStreams")}},wyZ=function(m,F,L,u){if(m&&m.streamsProgress){u=m;
a:{F=`${F.itag};${F.xtags}`;var q=m.streamsProgress;for(let A=0;A<q.length;A++){const r=JSON.parse(q[A].formatStreamBytes);if(`${r.itag};${r.xtags}`===F){q[A]=L;L=q;break a}}q.push(L);L=q}u.streamsProgress=L}else m={key:u,streamsProgress:[L]};return m},lke=function(m){if(m?.streamsProgress){let F=0;
m=m.streamsProgress;for(let L=0;L<m.length;L++){const u=m[L];isNaN(Number(u.numBytesDownloaded))?b_("stream progress bytes number invalid"):F+=Number(u.numBytesDownloaded)}return F}return 0},XHR=async function(m){if(m.X){const F=m.X;
m.V.stop();await kl(m,"TRANSFER_STATE_PAUSED_BY_USER");const L=F?.key?g.cf(F.key).entityId:"";L&&m.G&&await Fo(L,m.G,m.B,"DOWNLOAD_STATE_PAUSED");const u=await h3(m,L);OGq({videoId:L,cM:F,offlineModeType:u})}else Wb(m,"onTransferPausedByUser");Oe(m);Qp(m)},tvf=async function(m){if(m.X){m.V.stop();
await kl(m,"TRANSFER_STATE_TRANSFER_IN_QUEUE");var F=m.X;(F=F?.key?g.cf(F.key).entityId:"")&&m.G&&await Fo(F,m.G,m.B,"DOWNLOAD_STATE_PAUSED");Oe(m)}else Wb(m,"onTransferPausedByNetwork")},se=async function(m){if(m.X){m.V.start(108E5);
await kl(m,"TRANSFER_STATE_TRANSFERRING");var F=m.X;(F=F?.key?g.cf(F.key).entityId:"")&&m.G&&await Fo(F,m.G,m.B,"DOWNLOAD_STATE_DOWNLOAD_IN_PROGRESS")}else Wb(m,"onTransferStart")},Ike=async function(m,F,L){if(m.X){m.X.transferState!=="TRANSFER_STATE_TRANSFERRING"&&await se(m);
var u=Date.now();u-m.Hb>1E3&&(m.Hb=u,await VgN(m.B,L.videoId,L.B,L.gR,L.bytesDownloaded,L.X),!m.W||m.W&&u-m.XN>m.JF)&&(m.XN=u,u=await h3(m,F),WoZ({videoId:F,cM:m.X,offlineModeType:u},L.bytesDownloaded,L.X));m.V.start(108E5)}else Wb(m,`onTransferProgress: ${F}`)},$Qq=async function(m){if(m.X){var F=m.X;
m.V.stop();if(F&&m.O){var L=r5(m.api.K(),F.cotn,m.O);await Rk2(m,L)}await kl(m,"TRANSFER_STATE_COMPLETE","DOWNLOAD_STREAM_STATE_COMPLETE");(L=F?.key?g.cf(F.key).entityId:"")&&m.G&&await Fo(L,m.G,m.B,"DOWNLOAD_STATE_COMPLETE");await j$q(m.B,L);var u=await h3(m,L);BU({transferStatusType:"TRANSFER_STATUS_TYPE_COMPLETED",statusType:"SUCCESS"},{videoId:L,cM:F,offlineModeType:u});Oe(m);Qp(m)}else Wb(m,"onTransferComplete")},ekc=async function(m){await gq2();
m=m.b9;var F=g.Sz();F=Object.keys(F);await vnm(m,F)},gn2=async function(m){m=(await Xu(m.B,"transfer")).filter(PRt).sort(iJG);
return m.length===0?void 0:m[0]},ak6=async function(m,F){if(!m.Z){m.Z=!0;
m.X=F;var L=g.cf(m.X.key).entityId;if(m.X.transferState==="TRANSFER_STATE_TRANSFERRING"){var u=await h3(m,L);BU({transferStatusType:"TRANSFER_STATUS_TYPE_RESUME_PROCESSING",statusType:"OFFLINING_RETRIED"},{videoId:L,cM:m.X,offlineModeType:u})}else m.X.transferState!=="TRANSFER_STATE_TRANSFER_IN_QUEUE"||m.X.transferRetryCount||m.X.hasLoggedFirstStarted||(u=await h3(m,L),m.X.hasLoggedFirstStarted=!0,await zkC(m),WoZ({videoId:L,cM:m.X,offlineModeType:u},void 0,void 0,!0));await se(m);L=null;try{L=await YoG(m,
F),m.O=L}catch(q){b_("error getting player response",q,F.cotn);await m.D3("TRANSFER_FAILURE_REASON_SERVER_PROPERTY_MISSING");return}u=r5(m.api.K(),F.cotn,L);await Rk2(m,u);u.rM=await o6R(u.videoId);L=m.L;F=F.maximumDownloadQuality;u.getPlayerResponse();g.XO(u.videoId,2);L.G=2;L.B=!1;L.player?.dispose();L.player=L.api.dk(u);L.player.YE({localmediachange:L.CQ,signatureexpired:L.xt,statechange:L.V},L);L.N("html5_generate_content_po_token")&&L.player.Yi();F=L.Mf(F);L.player.Sq(g.cp(F,F,!0,"m"),!1);L.player.sW(!1);
m.V.start(108E5)}},Oe=function(m){m.X=void 0;
m.O=void 0;m.V.stop()},Qp=async function(m,F=!1){if(m.X)throw Error("Already downloading a video");
m.XN=0;m.Z=!1;const L=await gn2(m);hSC(m.xC,!L);L&&m.j.X2()?(F&&await new Promise(u=>{g.M9(u,1E3)}),await ak6(m,L)):!L&&m.X&&Oe(m)},h3=async function(m,F){return(await oA(m.B,g.dD(F,"videoDownloadContextEntity"),"videoDownloadContextEntity"))?.offlineModeType??void 0},DQm=async function(m){m.O&&(await o5(m.L,m.O.videoDetails.videoId),Oe(m))},Rk2=async function(m,F){try{(F.captionTracks.length||F.Ou)&&!await G$8(F.videoId)&&await yLC(m.i9,F)}catch(L){b_("Caption downloading error",L,F.cotn)}},zkC=
async function(m,F){if(m.X){var L=m.X;
await ME(m.B,{mode:"readwrite",JW:!0},u=>{const q=[p6(u,L,"transfer")];F&&q.push(F(u));return g.hW.all(q)})}},YoG=async function(m,F){F=g.cf(F.key).entityId;
F=g.dD(F,"playbackData");m=await oA(m.B,F,"playbackData");if(m?.playerResponseJson)return JSON.parse(m.playerResponseJson);throw Error("No PlayerResponse found");},kl=async function(m,F,L,u){if(m.X){m.X.transferState=F;
m.X.failureReason=u;try{await zkC(m,q=>L?D7(q,"offlineVideoStreams",m.X.offlineVideoStreams).then(A=>{for(const r of A)if(r&&r.streamsProgress)for(const y of r.streamsProgress)y.streamState=L;return K6(q,A.filter(r=>!!r),"offlineVideoStreams")}):g.hW.resolve(void 0))}catch(q){q instanceof g.Xa&&q.type==="QUOTA_EXCEEDED"&&await m.D3("TRANSFER_FAILURE_REASON_FILESYSTEM_WRITE")}}else Wb(m,`saveTransferState: ${F}`)},Wb=function(m,F){m.api.Bb("woffle",{mcte:F});
b_("missing current transfer entity.")},T4e=function(m){const F=(m.X.transferRetryCount||0)<3;
F&&(m=m.X,m.transferRetryCount=(m.transferRetryCount||0)+1);return F},N4Z=async function(m,F="TRANSFER_FAILURE_REASON_UNKNOWN"){m.X||Wb(m,`setTransferToFailed: ${F}`);
var L="OFFLINE_OPERATION_FAILURE_REASON_UNKNOWN";F==="TRANSFER_FAILURE_REASON_NETWORK"?L="OFFLINE_OPERATION_FAILURE_REASON_NETWORK_REQUEST_FAILED":F==="TRANSFER_FAILURE_REASON_FILESYSTEM_WRITE"&&(L="OFFLINE_OPERATION_FAILURE_REASON_DATABASE_REQUEST_FAILED");await kl(m,"TRANSFER_STATE_FAILED","DOWNLOAD_STREAM_STATE_ERROR_STREAMS_MISSING",F);cU(m.T,{entityKey:m.X?.key,failureReason:L});L=m.X?g.cf(m.X.key).entityId:"";const u=await h3(m,L);m={videoId:L,cM:m.X,offlineModeType:u};L={transferStatusType:"TRANSFER_STATUS_TYPE_TERMINATED_WITH_FAILURE",
statusType:"FAILED"};F&&(L.transferFailureReason=F,L.failureReason=Qu8(F));BU(L,m)},PRt=function(m){return bX[m.transferState]!==void 0},iJG=function(m,F){const L=bX[m.transferState],u=bX[F.transferState];
return L!==u?L-u:Number(m.enqueuedTimestampMs)-Number(F.enqueuedTimestampMs)},pyc=async function(m){g.sP(m.api,"onOrchestrationBecameLeader");
await m.Md()},xQR=async function(m){const F=await ET();
if(F){m.B=new Kgq(F,m.api,m.G,m.X);var L=m.j(F);m.Z=await HYq(F,L,m.G,m.X,m.S);await fkR(m)}else b_("PES is undefined")},fkR=async function(m){if(m.B){m.B.X||await Qp(m.B);
m.S.N("woffle_enable_main_downloads_library")&&await m.M0();m.S.N("html5_offline_playback_position_sync")&&(await m.Hb(),await m.jn(864E5));await m.refreshAllStaleEntities(43200,!0);await m.W();m.S.N("html5_retry_downloads_for_expiration")&&await m.wr();m.XN=g.Zp(()=>{m.refreshAllStaleEntities(43200,!0);m.W()},9E5);
g.zk(g.aJ(),()=>m.KE());
var F=await ET();await t_Z(F);U1N(m.G)}else b_("transferManager is undefined")},Mgm=async function(){const m=await ET();
if(!m)return[];const F=Date.now()/1E3,L=await Xu(m,"offlineVideoPolicy");for(const u of L)u.expirationTimestamp&&Number(u.expirationTimestamp)<F&&(u.action="OFFLINE_VIDEO_POLICY_ACTION_DISABLE",u.offlinePlaybackDisabledReason="OFFLINE_PLAYBACK_DISABLED_REASON_CLIENT_OFFLINE_CONTENT_EXPIRED",await Z7(m,u,"offlineVideoPolicy"));return L.map(u=>u.key)},cb=async function(m,F,L,u,q){var A=await ET();
if(!A)return[];F=F.map(r=>{var y=g.dD(r,L);y={actionType:u,entityKey:y,actionMetadata:{...yp(),...q}};u!=="OFFLINE_ORCHESTRATION_ACTION_TYPE_REFRESH"&&(y.actionMetadata.priority=0);r=new GQ(L,r,y);return lX(r)});
A=lX6(A,F);EqZ(m.G);return A},ZJN=async function(m,F,L,u){const q=[];
for(const A of F)if(!A.upToDate&&(!L||A.shouldAutoSyncMetadata)&&A.playlistId){F={};switch(u){case "mainPlaylistEntity":F={mainPlaylistEntityActionMetadata:{nextAutoRefreshIntervalSeconds:A.checkInSeconds,autoSync:L}};break;case "musicPlaylist":F={musicPlaylistEntityActionMetadata:{autoSync:L}}}(F=await cb(m,[A.playlistId],u,"OFFLINE_ORCHESTRATION_ACTION_TYPE_REFRESH",F))&&q.push(...F)}return q},SoC=async function(m,F){if(F.length){const L=yp();
g.Xc(L,fZ,{isEnqueuedForExpiredStreamUrlRefetch:!0});m.api.Bb("qrd",{v:F.length});return cb(m,F,"playbackData","OFFLINE_ORCHESTRATION_ACTION_TYPE_ADD",L)}return[]},XyC=async function(m,F){const L=HU(F);
var u=g.cf(F.entityKey).entityId;let q=[];try{q=await on6(m,u),m.S.N("woffle_enable_main_downloads_library")&&q?.length&&await e$(m.X,[F.entityKey])}catch(r){return F="OFFLINE_OPERATION_FAILURE_REASON_UNKNOWN",u="OFFLINE_ORCHESTRATION_FAILURE_REASON_DATABASE_OPERATION_FAILED",r instanceof g.Xa&&r.type==="QUOTA_EXCEEDED"?(F="OFFLINE_OPERATION_FAILURE_REASON_DATABASE_REQUEST_FAILED",u="OFFLINE_ORCHESTRATION_FAILURE_REASON_NO_STORAGE"):b_("Playlist add error"),new Mw("OFFLINE_ORCHESTRATION_ACTION_RESULT_FAILURE",
L,void 0,F,u)}const A=[];m.S.N("html5_offline_prevent_redownload_downloaded_video")&&(q=await A3(m.X,"mainVideoEntity",q));if(q?.length)for(const r of q)m=r.offlineVideoData,m?.videoId&&A.push(KZ("OFFLINE_ORCHESTRATION_ACTION_TYPE_ADD",m.videoId,"mainVideoEntity",Number(F.actionMetadata?.priority||0)+1,d5,nZ(F,m,u)));return new Mw("OFFLINE_ORCHESTRATION_ACTION_RESULT_SUCCESS",L,A)},Ene=async function(m,F){const L=HU(F);
var u=F.entityKey,q=g.cf(u).entityId,A=[],r=!1;q==="!*$_ALL_ENTITIES_!*$"?(r=!0,A=await Xu(m.X,"mainPlaylistEntity")):(u=await oA(m.X,u,"mainPlaylistEntity"))&&A.push(u);if(!A?.length)return new Mw("OFFLINE_ORCHESTRATION_ACTION_RESULT_SUCCESS",L);var y=g.p(F.actionMetadata,tgZ);u=y?.nextAutoRefreshIntervalSeconds;const G=y?.autoSync;let v=[],l=!0;y=!0;let w=!1;if(r||G!==!1){try{v=await Vvc(0,!!G,!0,A)}catch(N){N instanceof Error&&N.message==="No data"?q==="!*$_ALL_ENTITIES_!*$"?await R5(m.X,F,m.G,
"OFFLINE_DELETE_REASON_UNAVAILABLE"):await I5(q,m.X,F,m.G):N instanceof Error&&N.message==="Empty response body"&&b_(N.message)}if(!v.length||!r&&v[0].playlistId!==q)return new Mw("OFFLINE_ORCHESTRATION_ACTION_RESULT_SUCCESS",L)}if(r){F=[];for(var V of v)V.upToDate||G&&!V.shouldAutoSyncMetadata||!V.playlistId||F.push(KZ("OFFLINE_ORCHESTRATION_ACTION_TYPE_REFRESH",V.playlistId,"mainPlaylistEntity",0,d5,{mainPlaylistEntityActionMetadata:{nextAutoRefreshIntervalSeconds:V.checkInSeconds,autoSync:G}}));
return new Mw("OFFLINE_ORCHESTRATION_ACTION_RESULT_SUCCESS",L,F)}v.length&&(V=v[0],w=!!V.upToDate,G&&(l=V.shouldAutoSyncMetadata??!0,y=V.shouldAutoSyncVideos??!0,V.checkInSeconds&&(u=V.checkInSeconds)));if(w||!l)return new Mw("OFFLINE_ORCHESTRATION_ACTION_RESULT_SUCCESS",L);V=[];A=A[0];r=A.downloadState?await oA(m.X,A.downloadState,"mainPlaylistDownloadStateEntity"):void 0;r=r?.addedTimestampMillis?String(r.addedTimestampMillis):void 0;try{V=await on6(m,q,r,u)}catch(N){if(N instanceof Error&&N.message===
"No data for playlist")await I5(q,m.X,F,m.G);else if(N instanceof Error&&N.message==="Empty response body for playlist")b_(N.message);else return F="OFFLINE_OPERATION_FAILURE_REASON_UNKNOWN",q="OFFLINE_ORCHESTRATION_FAILURE_REASON_DATABASE_OPERATION_FAILED",N instanceof g.Xa&&N.type==="QUOTA_EXCEEDED"&&(F="OFFLINE_OPERATION_FAILURE_REASON_DATABASE_REQUEST_FAILED",q="OFFLINE_ORCHESTRATION_FAILURE_REASON_NO_STORAGE"),new Mw("OFFLINE_ORCHESTRATION_ACTION_RESULT_FAILURE",L,void 0,F,q)}if(!y)return new Mw("OFFLINE_ORCHESTRATION_ACTION_RESULT_SUCCESS",
L);m=[];u=new Map;if(V?.length)for(var I of V)y=I.offlineVideoData,y?.videoId&&u.set(y.videoId,y);I=new Map;y=[];if(A?.videos?.length)for(var P of A.videos)if(A=JSON.parse(g.cf(P).entityId).videoId)u.has(A)?(I.set(A,u.get(A)),u.delete(A)):y.push(A);P=Number(F.actionMetadata?.priority||0)+1;for(const [N,x]of u.entries())m.push(KZ("OFFLINE_ORCHESTRATION_ACTION_TYPE_ADD",N,"mainVideoEntity",P,d5,nZ(F,x,q)));for(const [N,x]of I.entries())m.push(KZ("OFFLINE_ORCHESTRATION_ACTION_TYPE_REFRESH",N,"mainVideoEntity",
P,d5,nZ(F,x,q)));for(const N of y)m.push(KZ("OFFLINE_ORCHESTRATION_ACTION_TYPE_DELETE",N,"mainVideoEntity",0,d5,{offlineLoggingData:{offlineDeleteReason:"OFFLINE_DELETE_REASON_PARENT_LIST_REFRESH"},mainVideoEntityActionMetadata:{playlistId:q}}));return new Mw("OFFLINE_ORCHESTRATION_ACTION_RESULT_SUCCESS",L,m)},UQN=async function(m,F){const L=HU(F);
try{const u=g.cf(F.entityKey).entityId;u==="!*$_ALL_ENTITIES_!*$"?await R5(m.X,F,m.G,F.actionMetadata?.offlineLoggingData?.offlineDeleteReason):(await I5(u,m.X,F,m.G),m.S.N("woffle_enable_main_downloads_library")&&await Pb(m.X,F.entityKey))}catch(u){return new Mw("OFFLINE_ORCHESTRATION_ACTION_RESULT_FAILURE",L,void 0,"OFFLINE_OPERATION_FAILURE_REASON_DATABASE_REQUEST_FAILED","OFFLINE_ORCHESTRATION_FAILURE_REASON_DATABASE_OPERATION_FAILED")}return new Mw("OFFLINE_ORCHESTRATION_ACTION_RESULT_SUCCESS",
L)},on6=async function(m,F,L,u){F=await pZ([F]);
const {mainPlaylistEntity:q,kN:A}=await k$t(m,F[0],L,u);m=nqm(q,A?.avatar);try{await Vp(m)}catch(r){r instanceof Error&&r.message==="Failed to fetch"&&b_(r.message)}return F[0].videos},nZ=function(m,F,L){F={offlineVideoData:F,
playlistId:L};if(m=g.p(m.actionMetadata,tgZ))F.maximumDownloadQuality=m.maximumDownloadQuality;return{mainVideoEntityActionMetadata:F}},k$t=async function(m,F,L,u){const q=Date.now().toString();
L||(L=q);var A=F.videos;const r=F.playlistId,y=[],G=[];if(A)for(const V of A){A=V.offlineVideoData;if(!A||!A.videoId)throw b_("Invalid offlineVideoData for playlist"),Error("Invalid offlineVideoData for playlist");A=A.videoId;A={id:g.dD(JSON.stringify({videoId:A,playlistId:r}),"mainPlaylistVideoEntity"),video:g.dD(A,"mainVideoEntity")};y.push(A);G.push(A.id)}let v;const l={key:g.dD(r,"mainPlaylistDownloadStateEntity"),addedTimestampMillis:L,lastSyncedTimestampMillis:q},w={key:g.dD(r,"mainPlaylistEntity"),
playlistId:r,videos:G,title:F.title,thumbnailStyleData:hke(F),visibility:Wge(F),downloadState:l.key};F.channel&&(L=F.channel.offlineChannelData,v=OJe(g.dD(r,"ytMainChannelEntity"),L),w.channelOwner=v.id);w?.entityMetadata?(w.entityMetadata.offlineLastModifiedTimestampSeconds=F.lastModifiedTimestamp,u&&(w.entityMetadata.nextAutoRefreshIntervalSeconds=String(u))):w&&(w.entityMetadata={nextAutoRefreshIntervalSeconds:u?String(u):void 0,offlineLastModifiedTimestampSeconds:F.lastModifiedTimestamp});try{await ME(m.X,
{mode:"readwrite",JW:!0},V=>{var I=p6(V,w,"mainPlaylistEntity");const P=p6(V,l,"mainPlaylistDownloadStateEntity");I=[I,P];for(const N of y)I.push(p6(V,N,"mainPlaylistVideoEntity"));v&&I.push(p6(V,v,"ytMainChannelEntity"));return g.hW.all(I)})}catch(V){throw b_("PES failure for playlist"),Error("PES failure for playlist");
}return{mainPlaylistEntity:w,kN:v,ZrP:y}},hke=function(m){const F=[];
var L=m.videos;L&&L.length>0&&F.push({key:Number("PLAYLIST_THUMBNAIL_STYLE_FIRST_VIDEO"),value:{collageThumbnail:{coverThumbnail:L[0].offlineVideoData.thumbnail}}});if((m=m.additionalMetadadatas)&&m.length>0)for(const u of m)switch(m=u.offlineBundleItemPlaylistData,L={collageThumbnail:{coverThumbnail:m?.coverThumbnail}},m?.style){case "BUNDLE_ITEM_STYLE_UNSPECIFIED":F.push({key:Number("PLAYLIST_THUMBNAIL_STYLE_UNKNOWN"),value:L});break;case "BUNDLE_ITEM_STYLE_TWO_BY_TWO":F.push({key:Number("PLAYLIST_THUMBNAIL_STYLE_TWO_BY_TWO"),
value:L});break;case "BUNDLE_ITEM_STYLE_ONE_AND_TWO_AVATAR":F.push({key:Number("PLAYLIST_THUMBNAIL_STYLE_ONE_AND_TWO_AVATAR"),value:L});break;case "BUNDLE_ITEM_STYLE_ONE_AND_TWO":F.push({key:Number("PLAYLIST_THUMBNAIL_STYLE_ONE_AND_TWO"),value:L})}return F},Wge=function(m){switch(m.privacy){case "PRIVATE":return"PLAYLIST_VISIBILITY_PRIVATE";
case "PUBLIC":return"PLAYLIST_VISIBILITY_PUBLIC";case "UNLISTED":return"PLAYLIST_VISIBILITY_UNLISTED";default:return"PLAYLIST_VISIBILITY_UNKNOWN"}},OJe=function(m,F){return{id:m,
channelId:F.channelId,title:F.title,avatar:F.thumbnail}},bJ8=async function(m,F){const L=HU(F);
var u=g.cf(F.entityKey).entityId;const q=g.p(F.actionMetadata,Bb),A=!q?.playlistId;try{await Q$e(m,u,void 0,q?.offlineVideoData,A)}catch(r){return u="OFFLINE_OPERATION_FAILURE_REASON_UNKNOWN",F="OFFLINE_ORCHESTRATION_FAILURE_REASON_DATABASE_OPERATION_FAILED",r instanceof g.Xa&&r.type==="QUOTA_EXCEEDED"&&(u="OFFLINE_OPERATION_FAILURE_REASON_DATABASE_REQUEST_FAILED",F="OFFLINE_ORCHESTRATION_FAILURE_REASON_NO_STORAGE"),new Mw("OFFLINE_ORCHESTRATION_ACTION_RESULT_FAILURE",L,void 0,u,F)}m=Number(F.actionMetadata?.priority||
0)+1;F=(F=g.p(F.actionMetadata,Bb))?{playbackDataActionMetadata:{maximumDownloadQuality:F.maximumDownloadQuality}}:void 0;u=KZ("OFFLINE_ORCHESTRATION_ACTION_TYPE_ADD",u,"playbackData",m,s$e,F);return new Mw("OFFLINE_ORCHESTRATION_ACTION_RESULT_SUCCESS",L,[u])},cLN=async function(m,F){const L=HU(F),u=g.cf(F.entityKey).entityId;
var q=await oA(m.X,F.entityKey,"mainVideoEntity"),A=q?await oA(m.X,q.downloadState,"mainVideoDownloadStateEntity"):void 0;if(!q||!A)return new Mw("OFFLINE_ORCHESTRATION_ACTION_RESULT_SUCCESS",L);let r;try{await Q$e(m,u,A.addedTimestampMillis,g.p(F.actionMetadata,Bb)?.offlineVideoData),q=1,q=Number(F.actionMetadata?.priority||0)+1,r=KZ("OFFLINE_ORCHESTRATION_ACTION_TYPE_REFRESH",u,"playbackData",q,s$e)}catch(y){if(y instanceof Error&&y.message==="No data"){q=await iX(m.X,u);if(A=g.p(F.actionMetadata,
Bb)?.playlistId)q.playlistId=A;q.offlineDeleteReason="OFFLINE_DELETE_REASON_UNAVAILABLE";await j$(u,m.X,F,m.G,q)}else if(y instanceof Error&&y.message==="Empty response body")b_(y.message);else return m="OFFLINE_OPERATION_FAILURE_REASON_UNKNOWN",F="OFFLINE_ORCHESTRATION_FAILURE_REASON_DATABASE_OPERATION_FAILED",y instanceof g.Xa&&y.type==="QUOTA_EXCEEDED"&&(m="OFFLINE_OPERATION_FAILURE_REASON_DATABASE_REQUEST_FAILED",F="OFFLINE_ORCHESTRATION_FAILURE_REASON_NO_STORAGE"),new Mw("OFFLINE_ORCHESTRATION_ACTION_RESULT_FAILURE",
L,void 0,m,F)}return new Mw("OFFLINE_ORCHESTRATION_ACTION_RESULT_SUCCESS",L,r?[r]:void 0)},dQ2=async function(m,F){const L=HU(F);
try{const u=g.cf(F.entityKey).entityId;if(u==="!*$_ALL_ENTITIES_!*$")await R5(m.X,F,m.G,F.actionMetadata?.offlineLoggingData?.offlineDeleteReason);else{const q=await iX(m.X,u),A=g.p(F.actionMetadata,Bb)?.playlistId;A&&(q.playlistId=A);q.offlineDeleteReason=F.actionMetadata?.offlineLoggingData?.offlineDeleteReason;await j$(u,m.X,F,m.G,q);m.S.N("woffle_enable_main_downloads_library")&&await Pb(m.X,F.entityKey)}}catch(u){return new Mw("OFFLINE_ORCHESTRATION_ACTION_RESULT_FAILURE",L,void 0,"OFFLINE_OPERATION_FAILURE_REASON_DATABASE_REQUEST_FAILED",
"OFFLINE_ORCHESTRATION_FAILURE_REASON_DATABASE_OPERATION_FAILED")}return new Mw("OFFLINE_ORCHESTRATION_ACTION_RESULT_SUCCESS",L)},Q$e=async function(m,F,L,u,q){u||(u=(await l28([F]))[0]);
const {mainVideoEntity:A,channelEntity:r}=await nnC(m,u,L,q);try{const y=qw(A.thumbnail),G=qw(r.avatar);await Vp(y.concat(G))}catch(y){y instanceof Error&&y.message==="Failed to fetch"&&b_(y.message)}},nnC=async function(m,F,L,u){L||(L=Date.now().toString());
const q=F.channel?.offlineChannelData,A={id:g.dD(F.videoId,"ytMainChannelEntity"),channelId:q.channelId,title:q.title,avatar:q.thumbnail},r={key:g.dD(F.videoId,"mainVideoDownloadStateEntity"),playbackData:g.dD(F.videoId,"playbackData"),addedTimestampMillis:L,videoDownloadContextEntity:g.dD(F.videoId,"videoDownloadContextEntity")},y={key:g.dD(F.videoId,"videoPlaybackPositionEntity"),videoId:F.videoId,lastPlaybackPositionSeconds:"0"};let G;m.S.N("html5_offline_playback_position_sync")&&(G={playbackPosition:y.key});
L=g.dD(F.videoId,"mainVideoEntity");const v={key:L,videoId:F.videoId,title:F.title,thumbnail:F.thumbnail,localizedStrings:{viewCount:F.shortViewCountText},userState:G,lengthSeconds:F.lengthSeconds?Number(F.lengthSeconds):void 0,publishedTimestampMillis:F.publishedTimestamp?(Number(F.publishedTimestamp)*1E3).toString():void 0,formattedDescription:F.description,owner:A.id,downloadState:r.key};let l,w;m.S.N("woffle_enable_main_downloads_library")&&u&&(u=await LQe(m.X,[L]))&&(l=u.mainDownloadsLibraryEntity,
w=u.mainDownloadsListEntity);let V;V={key:g.dD(F.videoId,"downloadStatusEntity"),downloadState:"DOWNLOAD_STATE_PENDING_DOWNLOAD"};g.Xc(r,bGG,V);await ME(m.X,{mode:"readwrite",JW:!0},I=>{var P=p6(I,A,"ytMainChannelEntity"),N=p6(I,r,"mainVideoDownloadStateEntity");const x=p6(I,v,"mainVideoEntity");P=[P,N,x];m.S.N("html5_offline_playback_position_sync")&&(N=p6(I,y,"videoPlaybackPositionEntity"),P.push(N));l&&(N=p6(I,l,"mainDownloadsLibraryEntity"),P.push(N));w&&(N=p6(I,w,"mainDownloadsListEntity"),P.push(N));
V&&(I=p6(I,V,"downloadStatusEntity"),P.push(I));return g.hW.all(P)});
return{mainVideoEntity:v,channelEntity:A}},HJ2=async function(m,F){const L=HU(F),u=[];
var q=await ZQ.getInstance();let A,r;q&&(A=await q.get("sdois"),r=await q?.get("lmqf"));try{if(A===void 0)throw Error("prefStorage or opt-in state is undefined");q=[];A||(q=await FQt(m.X),q.reverse());if(q.length)for(const v of q){if(!v)continue;const l=g.cf(v).entityId,w=await iX(m.X,l);w.offlineDeleteReason="OFFLINE_DELETE_REASON_PARENT_LIST_DELETE";await j$(l,m.X,{entityKey:v,actionType:F.actionType},m.G,w)}const y=await I22(A,r??"SD");await Jaf(y);const G=muG(y);m.S.N("woffle_enable_main_downloads_library")&&
(A||await Pb(m.X,g.Ox),await e$(m.X,[g.Ox]));if(G?.length)for(const v of G){const l=v.actionType,w=v.entityKey,V=v.actionMetadata;if(l&&w&&V&&!g.p(V,B4C)){l==="OFFLINE_ORCHESTRATION_ACTION_TYPE_DELETE"&&(V.offlineLoggingData={offlineDeleteReason:"OFFLINE_DELETE_REASON_PARENT_LIST_DELETE"});const I=g.p(v.actionMetadata,Bb);I&&(I.playlistId="DOWNLOADS_LIST_ENTITY_ID_SMART_DOWNLOADS",v.actionMetadata={...v.actionMetadata,mainVideoEntityActionMetadata:I});u.push(v)}}}catch(y){return m="OFFLINE_OPERATION_FAILURE_REASON_UNKNOWN",
F="OFFLINE_ORCHESTRATION_FAILURE_REASON_DATABASE_OPERATION_FAILED",y instanceof g.Xa&&y.type==="QUOTA_EXCEEDED"&&(m="OFFLINE_OPERATION_FAILURE_REASON_DATABASE_REQUEST_FAILED",F="OFFLINE_ORCHESTRATION_FAILURE_REASON_NO_STORAGE"),new Mw("OFFLINE_ORCHESTRATION_ACTION_RESULT_FAILURE",L,void 0,m,F)}return new Mw("OFFLINE_ORCHESTRATION_ACTION_RESULT_SUCCESS",L,u)},JLR=async function(m,F=43200,L=!0){if(!m.L.X2())return[];
let u=[];try{u=await Vvc(F,L,!1)}catch(q){q instanceof Error&&q.message==="No data"||q instanceof Error&&q.message==="Empty response body"&&b_(q.message)}return ZJN(m,u,L,"mainPlaylistEntity")},CRf=async function(m,F,L,u=!1){let q=[];
if(!await jcf()&&!u)return[];L=await R7C(F,L);if(!L?.length)return[];F={offlineDeleteReason:"OFFLINE_DELETE_REASON_PARENT_LIST_REFRESH"};for(const r of L){L=r.actionType;var A=r.entityKey;u=r.actionMetadata;L&&A&&u&&!g.p(u,B4C)&&(L==="OFFLINE_ORCHESTRATION_ACTION_TYPE_DELETE"&&(u.offlineLoggingData=F),{entityId:A}=g.cf(A),L=await cb(m,[A],"mainVideoEntity",L,u),q=q.concat(L))}return q},FAR=async function(m,F){const L=HU(F);
var u=g.cf(F.entityKey).entityId;let q=[];try{q=await mOc(m,u),q?.length&&await a5(m.X,F.entityKey)}catch(r){return F="OFFLINE_OPERATION_FAILURE_REASON_UNKNOWN",u="OFFLINE_ORCHESTRATION_FAILURE_REASON_DATABASE_OPERATION_FAILED",r instanceof g.Xa&&r.type==="QUOTA_EXCEEDED"&&(F="OFFLINE_OPERATION_FAILURE_REASON_DATABASE_REQUEST_FAILED",u="OFFLINE_ORCHESTRATION_FAILURE_REASON_NO_STORAGE"),new Mw("OFFLINE_ORCHESTRATION_ACTION_RESULT_FAILURE",L,void 0,F,u)}const A=[];q=await A3(m.X,"musicTrack",q);if(q.length)for(const r of q)m=
r.offlineVideoData,m?.videoId&&A.push(KZ("OFFLINE_ORCHESTRATION_ACTION_TYPE_ADD",m.videoId,"musicTrack",Number(F.actionMetadata?.priority||0)+1,Hb,TQ(F,m,u)));return new Mw("OFFLINE_ORCHESTRATION_ACTION_RESULT_SUCCESS",L,A)},LA2=async function(m,F){const L=HU(F);
var u=F.entityKey,q=g.cf(u).entityId,A=[],r=!1;q==="!*$_ALL_ENTITIES_!*$"?(r=!0,A=await Xu(m.X,"musicAlbumRelease")):(u=await oA(m.X,u,"musicAlbumRelease"))&&A.push(u);if(!A?.length)return new Mw("OFFLINE_ORCHESTRATION_ACTION_RESULT_SUCCESS",L);if(r){F=[];for(var y of A){var G=g.cf(y.id).entityId;F.push(KZ("OFFLINE_ORCHESTRATION_ACTION_TYPE_REFRESH",G,"musicAlbumRelease",0,Hb))}return new Mw("OFFLINE_ORCHESTRATION_ACTION_RESULT_SUCCESS",L,F)}y=[];A=A[0];r=void 0;A.downloadMetadata&&(r=await oA(m.X,
A.downloadMetadata,"musicAlbumReleaseDownloadMetadataEntity"),r=Number(r?.addedTimestampMillis??"0")/1E3);try{y=await mOc(m,q,r?.toString())}catch(w){if(w instanceof Error&&w.message==="No data")await zQ(q,"musicAlbumRelease",m.X,F,m.G);else if(w instanceof Error&&w.message==="Empty response body")b_(w.message);else return F="OFFLINE_OPERATION_FAILURE_REASON_UNKNOWN",G="OFFLINE_ORCHESTRATION_FAILURE_REASON_DATABASE_OPERATION_FAILED",w instanceof g.Xa&&w.type==="QUOTA_EXCEEDED"&&(F="OFFLINE_OPERATION_FAILURE_REASON_DATABASE_REQUEST_FAILED",
G="OFFLINE_ORCHESTRATION_FAILURE_REASON_NO_STORAGE"),new Mw("OFFLINE_ORCHESTRATION_ACTION_RESULT_FAILURE",L,void 0,F,G)}m=[];q=new Map;if(y?.length)for(var v of y)y=v.offlineVideoData,y?.videoId&&q.set(y.videoId,y);v=new Map;y=[];if(A?.tracks?.length)for(var l of A.tracks)if(A=g.cf(l).entityId)q.has(A)?(v.set(A,q.get(A)),q.delete(A)):y.push(A);l=Number(F.actionMetadata?.priority||0)+1;for(const [w,V]of q.entries())m.push(KZ("OFFLINE_ORCHESTRATION_ACTION_TYPE_ADD",w,"musicTrack",l,Hb,TQ(F,V)));for(const [w,
V]of v.entries())m.push(KZ("OFFLINE_ORCHESTRATION_ACTION_TYPE_REFRESH",w,"musicTrack",l,Hb,TQ(F,V)));for(G of y)m.push(KZ("OFFLINE_ORCHESTRATION_ACTION_TYPE_DELETE",G,"musicTrack",0,Hb));return new Mw("OFFLINE_ORCHESTRATION_ACTION_RESULT_SUCCESS",L,m)},u5c=async function(m,F){const L=HU(F);
try{const u=g.cf(F.entityKey).entityId;u==="!*$_ALL_ENTITIES_!*$"?await Yl(m.X,F,m.G):(await zQ(u,"musicAlbumRelease",m.X,F,m.G),await DQ(m.X,F.entityKey))}catch(u){return new Mw("OFFLINE_ORCHESTRATION_ACTION_RESULT_FAILURE",L,void 0,"OFFLINE_OPERATION_FAILURE_REASON_DATABASE_REQUEST_FAILED","OFFLINE_ORCHESTRATION_FAILURE_REASON_DATABASE_OPERATION_FAILED")}return new Mw("OFFLINE_ORCHESTRATION_ACTION_RESULT_SUCCESS",L)},mOc=async function(m,F,L){F=await pZ([F]);
m=await q46(m,F[0],L);m=qw(m.thumbnailDetails);await Vp(m);return F[0].videos},q46=async function(m,F,L){var u=F.additionalMetadadatas;
let q=void 0;if(u&&u.length>0)for(var A of u)if(A.offlineMusicPlaylistData){q=A.offlineMusicPlaylistData;break}u=F.playlistId;const {Uo:r,e6:y}=yuf(F);L=L?(Number(L)*1E3).toString():Date.now().toString();A=F.lastModifiedTimestamp?(Number(F.lastModifiedTimestamp)*1E3).toString():"0";const G={id:g.dD(u,"musicAlbumReleaseDownloadMetadataEntity"),trackDownloadMetadatas:y,lastModifiedTimestampMillis:A,addedTimestampMillis:L,syncState:"DOWNLOAD_SYNC_STATE_UP_TO_DATE"},v={id:g.dD(u,"musicAlbumRelease"),
title:F.title,audioPlaylistId:u,trackCount:F.totalVideoCount,tracks:r,downloadMetadata:G.id};q&&(v.thumbnailDetails=q.albumHqThumbnail??q.albumArtistThumbnail,v.artistDisplayName=q.albumArtistDisplayName,v.releaseDate=q.albumReleaseDate,v.contentRating={explicitType:q.albumReleaseExplicitType},v.releaseType=q.albumReleaseType);await ME(m.X,{mode:"readwrite",JW:!0},l=>{const w=p6(l,v,"musicAlbumRelease");l=p6(l,G,"musicAlbumReleaseDownloadMetadataEntity");return g.hW.all([w,l])});
return v},r7Z=async function(m,F){const L=HU(F);
var u=g.cf(F.entityKey).entityId;let q=[];try{q=await A7q(m,u),q?.length&&await a5(m.X,F.entityKey)}catch(r){return F="OFFLINE_OPERATION_FAILURE_REASON_UNKNOWN",u="OFFLINE_ORCHESTRATION_FAILURE_REASON_DATABASE_OPERATION_FAILED",r instanceof g.Xa&&r.type==="QUOTA_EXCEEDED"&&(F="OFFLINE_OPERATION_FAILURE_REASON_DATABASE_REQUEST_FAILED",u="OFFLINE_ORCHESTRATION_FAILURE_REASON_NO_STORAGE"),new Mw("OFFLINE_ORCHESTRATION_ACTION_RESULT_FAILURE",L,void 0,F,u)}const A=[];q=await A3(m.X,"musicTrack",q);if(q.length)for(const r of q)m=
r.offlineVideoData,m?.videoId&&A.push(KZ("OFFLINE_ORCHESTRATION_ACTION_TYPE_ADD",m.videoId,"musicTrack",Number(F.actionMetadata?.priority||0)+1,J3,TQ(F,m,u)));return new Mw("OFFLINE_ORCHESTRATION_ACTION_RESULT_SUCCESS",L,A)},y7f=async function(m,F){const L=HU(F);
var u=F.entityKey,q=g.cf(u).entityId,A=[],r=!1;q==="!*$_ALL_ENTITIES_!*$"?(r=!0,A=await Xu(m.X,"musicPlaylist")):(u=await oA(m.X,u,"musicPlaylist"))&&A.push(u);if(!A?.length)return new Mw("OFFLINE_ORCHESTRATION_ACTION_RESULT_SUCCESS",L);const y=g.p(F.actionMetadata,GaC)?.autoSync;let G=[],v=!0;u=!0;let l=!1;var w=void 0;if(r||y!==!1){try{G=await $uZ(0,!!y,!0,A)}catch(x){x instanceof Error&&x.message==="No data"?q==="!*$_ALL_ENTITIES_!*$"?await Yl(m.X,F,m.G):await zQ(q,"musicPlaylist",m.X,F,m.G):x instanceof
Error&&x.message==="Empty response body"&&b_(x.message)}if(!G.length||!r&&G[0].playlistId!==q)return new Mw("OFFLINE_ORCHESTRATION_ACTION_RESULT_SUCCESS",L)}if(r){F=[];for(var V of G)V.upToDate||y&&!V.shouldAutoSyncMetadata||!V.playlistId||F.push(KZ("OFFLINE_ORCHESTRATION_ACTION_TYPE_REFRESH",V.playlistId,"musicPlaylist",0,J3,{musicPlaylistEntityActionMetadata:{autoSync:y}}));return new Mw("OFFLINE_ORCHESTRATION_ACTION_RESULT_SUCCESS",L,F)}G.length&&(V=G[0],l=!!V.upToDate,y&&(v=V.shouldAutoSyncMetadata??
!0,u=V.shouldAutoSyncVideos??!0,V.checkInSeconds&&(w=V.checkInSeconds)));if(l||!v)return new Mw("OFFLINE_ORCHESTRATION_ACTION_RESULT_SUCCESS",L);V=[];A=A[0];r=void 0;A.downloadMetadata&&(r=await oA(m.X,A.downloadMetadata,"musicPlaylistDownloadMetadataEntity"),r=Number(r?.addedTimestampMillis??"0")/1E3);try{V=await A7q(m,q,r?.toString(),w)}catch(x){if(x instanceof Error&&x.message==="No data")await zQ(q,"musicPlaylist",m.X,F,m.G);else if(x instanceof Error&&x.message==="Empty response body")b_(x.message);
else{F="OFFLINE_OPERATION_FAILURE_REASON_UNKNOWN";var I="OFFLINE_ORCHESTRATION_FAILURE_REASON_DATABASE_OPERATION_FAILED";x instanceof g.Xa&&x.type==="QUOTA_EXCEEDED"&&(F="OFFLINE_OPERATION_FAILURE_REASON_DATABASE_REQUEST_FAILED",I="OFFLINE_ORCHESTRATION_FAILURE_REASON_NO_STORAGE");return new Mw("OFFLINE_ORCHESTRATION_ACTION_RESULT_FAILURE",L,void 0,F,I)}}if(!u)return new Mw("OFFLINE_ORCHESTRATION_ACTION_RESULT_SUCCESS",L);m=[];q=new Map;if(V?.length)for(var P of V)u=P.offlineVideoData,u?.videoId&&
q.set(u.videoId,u);P=new Map;u=[];if(A?.tracks?.length)for(var N of A.tracks)if(w=g.cf(N).entityId)q.has(w)?(P.set(w,q.get(w)),q.delete(w)):u.push(w);N=Number(F.actionMetadata?.priority||0)+1;for(const [x,X]of q.entries())m.push(KZ("OFFLINE_ORCHESTRATION_ACTION_TYPE_ADD",x,"musicTrack",N,J3,TQ(F,X)));for(const [x,X]of P.entries())m.push(KZ("OFFLINE_ORCHESTRATION_ACTION_TYPE_REFRESH",x,"musicTrack",N,J3,TQ(F,X)));for(I of u)m.push(KZ("OFFLINE_ORCHESTRATION_ACTION_TYPE_DELETE",I,"musicTrack",0,J3));
return new Mw("OFFLINE_ORCHESTRATION_ACTION_RESULT_SUCCESS",L,m)},GrC=async function(m,F){const L=HU(F);
try{const u=g.cf(F.entityKey).entityId;u==="!*$_ALL_ENTITIES_!*$"?await Yl(m.X,F,m.G):(await zQ(u,"musicPlaylist",m.X,F,m.G),await DQ(m.X,F.entityKey))}catch(u){return new Mw("OFFLINE_ORCHESTRATION_ACTION_RESULT_FAILURE",L,void 0,"OFFLINE_OPERATION_FAILURE_REASON_DATABASE_REQUEST_FAILED","OFFLINE_ORCHESTRATION_FAILURE_REASON_DATABASE_OPERATION_FAILED")}return new Mw("OFFLINE_ORCHESTRATION_ACTION_RESULT_SUCCESS",L)},A7q=async function(m,F,L,u){F=await pZ([F]);
m=await vBe(m,F[0],L,u);m=qw(m.thumbnailDetails);await Vp(m);return F[0].videos},vBe=async function(m,F,L,u){const q=F.playlistId,{Uo:A,
e6:r}=yuf(F);L=L?(Number(L)*1E3).toString():Date.now().toString();const y=F.lastModifiedTimestamp?(Number(F.lastModifiedTimestamp)*1E3).toString():"0",G={id:g.dD(q,"musicPlaylistDownloadMetadataEntity"),trackDownloadMetadatas:r,lastModifiedTimestampMillis:y,addedTimestampMillis:L,syncState:"DOWNLOAD_SYNC_STATE_UP_TO_DATE"},v={id:g.dD(q,"musicPlaylist"),title:F.title,playlistId:q,thumbnailDetails:F.thumbnail,visibility:lIt(F),trackCount:F.totalVideoCount,tracks:A,downloadMetadata:G.id};u&&(v?.entityMetadata?
v.entityMetadata.nextAutoRefreshIntervalSeconds=String(u):v&&(v.entityMetadata={nextAutoRefreshIntervalSeconds:String(u)}));await ME(m.X,{mode:"readwrite",JW:!0},l=>{const w=p6(l,v,"musicPlaylist");l=p6(l,G,"musicPlaylistDownloadMetadataEntity");return g.hW.all([w,l])});
return v},lIt=function(m){switch(m.privacy){case "PRIVATE":return"PLAYLIST_ENTITY_VISIBILITY_PRIVATE";
case "PUBLIC":return"PLAYLIST_ENTITY_VISIBILITY_PUBLIC";case "UNLISTED":return"PLAYLIST_ENTITY_VISIBILITY_UNLISTED";default:return"PLAYLIST_ENTITY_VISIBILITY_UNKNOWN"}},jeq=async function(m,F){const L=HU(F);
var u=g.cf(F.entityKey).entityId;const q=g.p(F.actionMetadata,CZ);try{await wwC(m,u,void 0,q?.track,q?.albumRelease),q?.playlistId||await a5(m.X,F.entityKey)}catch(A){return F="OFFLINE_OPERATION_FAILURE_REASON_UNKNOWN",u="OFFLINE_ORCHESTRATION_FAILURE_REASON_DATABASE_OPERATION_FAILED",A instanceof g.Xa&&A.type==="QUOTA_EXCEEDED"&&(F="OFFLINE_OPERATION_FAILURE_REASON_DATABASE_REQUEST_FAILED",u="OFFLINE_ORCHESTRATION_FAILURE_REASON_NO_STORAGE"),new Mw("OFFLINE_ORCHESTRATION_ACTION_RESULT_FAILURE",L,
void 0,F,u)}m=(m=g.p(F.actionMetadata,CZ))?{playbackDataActionMetadata:{maximumDownloadQuality:m.maximumDownloadQuality}}:void 0;F=KZ("OFFLINE_ORCHESTRATION_ACTION_TYPE_ADD",u,"playbackData",Number(F.actionMetadata?.priority||0)+1,VrC,m);return new Mw("OFFLINE_ORCHESTRATION_ACTION_RESULT_SUCCESS",L,[F])},IIt=async function(m,F){const L=HU(F),u=g.cf(F.entityKey).entityId;
var q=await oA(m.X,F.entityKey,"musicTrack");const A=q?await oA(m.X,q.downloadMetadata,"musicTrackDownloadMetadataEntity"):void 0;if(!q||!A)return new Mw("OFFLINE_ORCHESTRATION_ACTION_RESULT_SUCCESS",L);let r;q=g.p(F.actionMetadata,CZ);try{await wwC(m,u,A.addedTimestampMillis,q?.track,q?.albumRelease),r=KZ("OFFLINE_ORCHESTRATION_ACTION_TYPE_REFRESH",u,"playbackData",Number(F.actionMetadata?.priority||0)+1,VrC)}catch(y){if(y instanceof Error&&y.message==="No data")await g5(u,m.X,F,m.G);else if(y instanceof
Error&&y.message==="Empty response body")b_(y.message);else return m="OFFLINE_OPERATION_FAILURE_REASON_UNKNOWN",F="OFFLINE_ORCHESTRATION_FAILURE_REASON_DATABASE_OPERATION_FAILED",y instanceof g.Xa&&y.type==="QUOTA_EXCEEDED"&&(m="OFFLINE_OPERATION_FAILURE_REASON_DATABASE_REQUEST_FAILED",F="OFFLINE_ORCHESTRATION_FAILURE_REASON_NO_STORAGE"),new Mw("OFFLINE_ORCHESTRATION_ACTION_RESULT_FAILURE",L,void 0,m,F)}return new Mw("OFFLINE_ORCHESTRATION_ACTION_RESULT_SUCCESS",L,r?[r]:void 0)},R58=async function(m,
F){const L=HU(F);
try{const u=g.cf(F.entityKey).entityId;u==="!*$_ALL_ENTITIES_!*$"?await Yl(m.X,F,m.G):(await g5(u,m.X,F,m.G),await DQ(m.X,F.entityKey))}catch(u){return new Mw("OFFLINE_ORCHESTRATION_ACTION_RESULT_FAILURE",L,void 0,"OFFLINE_OPERATION_FAILURE_REASON_DATABASE_REQUEST_FAILED","OFFLINE_ORCHESTRATION_FAILURE_REASON_DATABASE_OPERATION_FAILED")}return new Mw("OFFLINE_ORCHESTRATION_ACTION_RESULT_SUCCESS",L)},wwC=async function(m,F,L,u,q){u||(u=(await l28([F]))[0],u=ruN(u));
const {musicTrackEntity:A,yy:r}=await $O2(m,u,F,q,L);m=qw(A.thumbnailDetails);F=[];r&&(F=qw(r.thumbnailDetails));await Vp(m.concat(F))},$O2=async function(m,F,L,u,q){q||(q=Date.now().toString());
const A={id:g.dD(L,"musicTrackDownloadMetadataEntity"),playbackData:g.dD(L,"playbackData"),addedTimestampMillis:q,videoDownloadContextEntity:g.dD(L,"videoDownloadContextEntity")};u&&(F.albumRelease=u.id);await ME(m.X,{mode:"readwrite",JW:!0},r=>{const y=[];var G=p6(r,A,"musicTrackDownloadMetadataEntity");y.push(G);G=p6(r,F,"musicTrack");y.push(G);u&&(r=p6(r,u,"musicAlbumRelease"),y.push(r));return g.hW.all(y)});
await Fo(L,"musicTrackDownloadMetadataEntity",m.X,"DOWNLOAD_STATE_PENDING_DOWNLOAD");return{musicTrackEntity:F,yy:u}},e5G=async function(m,F=43200,L=!0){if(!m.L.X2())return[];
let u=[];try{u=await $uZ(F,L,!1)}catch(q){}return ZJN(m,u,L,"musicPlaylist")},PAm=function(m){let F;
m=g.p(m.getWatchNextResponse()?.currentVideoEndpoint,g.nl);m?.playlistId&&(F=m.playlistId);return F},i1f=async function(m,F){const L=F.clientPlaybackNonce,u={cpn:L,
offlineSourceVisualElement:g.ee(F.hF||"").getAsJson(),selectedOfflineMode:"OFFLINE_NOW",isPartialPlayback:!1};F.B&&(u.videoFmt=Number(F.B.itag));F.V&&(u.audioFmt=Number(F.V.itag));const q=PAm(F);var A;if(A=q&&F.videoId)F=F.videoId,A=await (q!=="PPSV"?Promise.resolve(!1):m.X.b9(F));A&&(u.selectedOfflineMode="OFFLINE_MODE_TYPE_AUTO_OFFLINE");m.B=L;g.RT("offlinePlaybackStarted",u)};
g.H8.prototype.dk=g.fM(42,function(m){return this.app.dk(m)});
g.ti.prototype.dk=g.fM(41,function(m){return g.Vcj(this,9,m)});
var mR=class{constructor(m){this.X=m}},F8=class extends mR{get entityMetadata(){return this.X.entityMetadata}set entityMetadata(m){this.X.entityMetadata=m}},gB6=class extends mR{B(){const m=[];this.X.video&&m.push(this.X.video);return[...(new Set(m))]}},z5e=class extends mR{B(){const m=[];this.X.video&&m.push(this.X.video);this.X.playlist&&m.push(this.X.playlist);this.X.videoItem&&m.push(this.X.videoItem);this.X.playlistItem&&m.push(this.X.playlistItem);return[...(new Set(m))]}},Y4G=class extends mR{B(){const m=
[];this.X.localImageEntities&&m.push(...this.X.localImageEntities);this.X.videoDownloadContextEntity&&m.push(this.X.videoDownloadContextEntity);return[...(new Set(m))]}},aI2=class extends mR{B(){const m=[];this.X.recommendedVideoMetadata&&m.push(...(new Y4G(this.X.recommendedVideoMetadata)).B());return[...(new Set(m))]}},DON=class extends mR{B(){const m=[];this.X.playbackPosition&&m.push(this.X.playbackPosition);return[...(new Set(m))]}},TZ8=class extends mR{B(){const m=[];this.X.creatorEntity&&m.push(this.X.creatorEntity);
return[...(new Set(m))]}},e7t=["browse","music/browse","streaming_browse","unplugged/browse"],YGe=["offline/playlist_sync_check"],v6C=["offline"],PbC=["offline/offline_video_playback_position_sync"],g6C=["offline/get_playback_data_entity"],eF,ZQ=class{constructor(m){this.token=m}static async getInstance(){return new Promise(m=>{g.l6().then(F=>{F?(ZQ.instance||(ZQ.instance=new ZQ(F)),m(ZQ.instance)):m(void 0)})})}async get(m){if(m=await (await PU(this.token)).get("prefs",m)){var F=(0,g.W)();
return m.expirationTimestampMs<=F?void 0:m.value}}async set(m,F,L=31536E3){const u=(0,g.W)();m={key:m,value:F,expirationTimestampMs:u+L*1E3};await (await PU(this.token)).put("prefs",m)}async remove(m){await (await PU(this.token)).delete("prefs",m)}},NZf={INVALID_ENCODER_VERSION:"Invalid encoder version",KEY_CREATION_FAILED:"Failed to create encoder key",UNKNOWN_DECODE_ERROR:"Failed to decode PES data",UNKNOWN_ENCODE_ERROR:"Failed to encode PES data",WRONG_DATA_TYPE:"Encoder cannot process the data type"},
i_=class extends g.Dj{constructor(m,F={}){super(NZf[m],{name:"PESEncoderError",type:m,...F});this.type=m;this.level="WARNING";Object.setPrototypeOf(this,i_.prototype)}},pwG=class{},KAN=class extends pwG{constructor(m){super();this.X=m}G(m,F){F=gk(F);m=(new TextEncoder).encode(JSON.stringify(m));return this.X.encrypt(m,F)}B(m,F){if(!(m instanceof Uint8Array))throw new i_("WRONG_DATA_TYPE",{aO:1});const L=new TextDecoder;F=gk(F);m=this.X.decrypt(m,F);return JSON.parse(L.decode(m))}},Foq={accountLinkStatusEntity:class extends F8{B(){return[]}},
booleanEntity:class extends F8{B(){return[]}},buttonEntity:class extends F8{B(){return[]}},captionTrack:class extends F8{B(){return[]}},channelHandle:class extends F8{B(){return[]}},chipEntity:class extends F8{B(){return[]}},commerceAcquisitionClientPayloadEntity:class extends F8{B(){return[]}},commerceCartListEntity:class extends F8{B(){return[]}},compositeSourceEntity:class extends F8{B(){return[]}},multiviewStagingEntity:class extends F8{B(){const m=[];this.X.compositeSourceKeys&&m.push(...this.X.compositeSourceKeys);
return[...(new Set(m))]}},contextNoteFeedEntityPayload:class extends F8{B(){return[]}},contextNoteUserRatingEntityPayload:class extends F8{B(){return[]}},continuationTokenEntity:class extends F8{B(){return[]}},downloadQualityPickerEntity:class extends F8{B(){return[]}},downloadsPageRefreshTokenEntity:class extends F8{B(){return[]}},downloadsPageViewConfigurationEntity:class extends F8{B(){return[]}},downloadStatusEntity:class extends F8{B(){return[]}},dismissState:class extends F8{B(){return[]}},
sfvAudioItemCurrentlyPlayingEntity:class extends F8{B(){return[]}},emojiFountainDataEntity:class extends F8{B(){return[]}},emojiCustomizationSetEntity:class extends F8{B(){return[]}},fakeChannel:class extends F8{B(){const m=[];this.X.alternateChannel&&m.push(this.X.alternateChannel);this.X.alternateChannelList&&m.push(...this.X.alternateChannelList);this.X.oneofChannelEntity&&m.push(this.X.oneofChannelEntity);return[...(new Set(m))]}},fakePlaylist:class extends F8{B(){const m=[];this.X.entryCollection&&
m.push(this.X.entryCollection);return[...(new Set(m))]}},fakePlaylistEntryCollection:class extends F8{B(){const m=[];this.X.parentPlaylist&&m.push(this.X.parentPlaylist);if(this.X.entries)for(const F of this.X.entries)m.push(...(new gB6(F)).B());return[...(new Set(m))]}},fakeVideo:class extends F8{B(){const m=[];this.X.descriptionEntity&&m.push(this.X.descriptionEntity);this.X.creators&&m.push(...this.X.creators);this.X.theBiggestFan&&m.push(this.X.theBiggestFan);return[...(new Set(m))]}},fakeVideoDescription:class extends F8{B(){return[]}},
featuredProductsEntity:class extends F8{B(){return[]}},flowStateEntity:class extends F8{B(){return[]}},iconBadgeEntity:class extends F8{B(){return[]}},interstitialInteractionStateEntity:class extends F8{B(){return[]}},likeButtonAnimationEntity:class extends F8{B(){return[]}},liveChatPollStateEntity:class extends F8{B(){return[]}},dataFreshnessEntity:class extends F8{B(){return[]}},liveViewerLeaderboardChatEntryPointStateEntity:class extends F8{B(){return[]}},liveViewerLeaderboardPointsEntity:class extends F8{B(){return[]}},
liveReactionsDataEntity:class extends F8{B(){return[]}},logoEntity:class extends F8{B(){return[]}},macroMarkerEntity:class extends F8{B(){return[]}},mainDownloadsLibraryEntity:class extends F8{B(){const m=[];this.X.downloadsList&&m.push(this.X.downloadsList);this.X.smartDownloadsList&&m.push(this.X.smartDownloadsList);this.X.recommendedDownloadsList&&m.push(this.X.recommendedDownloadsList);this.X.refresh&&m.push(this.X.refresh);return[...(new Set(m))]}},mainDownloadsListEntity:class extends F8{B(){const m=
[];this.X.refresh&&m.push(this.X.refresh);if(this.X.downloads)for(const F of this.X.downloads)m.push(...(new z5e(F)).B());return[...(new Set(m))]}},mainPlaylistDownloadStateEntity:class extends F8{B(){const m=[];this.X.localImageEntities&&m.push(...this.X.localImageEntities);return[...(new Set(m))]}},mainPlaylistEntity:class extends F8{B(){const m=[];this.X.channelOwner&&m.push(this.X.channelOwner);this.X.videos&&m.push(...this.X.videos);this.X.collaboratorChannels&&m.push(...this.X.collaboratorChannels);
this.X.downloadState&&m.push(this.X.downloadState);this.X.refresh&&m.push(this.X.refresh);return[...(new Set(m))]}},mainPlaylistVideoEntity:class extends F8{B(){const m=[];this.X.video&&m.push(this.X.video);this.X.channelContributor&&m.push(this.X.channelContributor);return[...(new Set(m))]}},mainVideoDownloadStateEntity:class extends F8{B(){const m=[];this.X.playbackData&&m.push(this.X.playbackData);this.X.localImageEntities&&m.push(...this.X.localImageEntities);this.X.videoDownloadContextEntity&&
m.push(this.X.videoDownloadContextEntity);return[...(new Set(m))]}},mainVideoEntity:class extends F8{B(){const m=[];this.X.owner&&m.push(this.X.owner);this.X.downloadState&&m.push(this.X.downloadState);this.X.userState&&m.push(...(new DON(this.X.userState)).B());this.X.additionalMetadata&&m.push(...(new aI2(this.X.additionalMetadata)).B());return[...(new Set(m))]}},markersEngagementPanelSyncEntity:class extends F8{B(){return[]}},markersVisibilityOverrideEntity:class extends F8{B(){return[]}},musicAlbumReleaseDetail:class extends F8{B(){const m=
[];this.X.albumRelease&&m.push(this.X.albumRelease);this.X.tracks&&m.push(...this.X.tracks);return[...(new Set(m))]}},musicAlbumReleaseDownloadMetadataEntity:class extends F8{B(){const m=[];this.X.trackDownloadMetadatas&&m.push(...this.X.trackDownloadMetadatas);return[...(new Set(m))]}},musicAlbumRelease:class extends F8{B(){const m=[];this.X.musicLibraryStatusEntity&&m.push(this.X.musicLibraryStatusEntity);this.X.primaryArtists&&m.push(...this.X.primaryArtists);this.X.details&&m.push(this.X.details);
this.X.userDetails&&m.push(this.X.userDetails);this.X.tracks&&m.push(...this.X.tracks);this.X.share&&m.push(this.X.share);this.X.downloadMetadata&&m.push(this.X.downloadMetadata);this.X.refresh&&m.push(this.X.refresh);return[...(new Set(m))]}},musicAlbumReleaseUserDetail:class extends F8{B(){const m=[];this.X.albumRelease&&m.push(this.X.albumRelease);return[...(new Set(m))]}},musicArtistDetail:class extends F8{B(){const m=[];this.X.parentArtist&&m.push(this.X.parentArtist);return[...(new Set(m))]}},
musicArtist:class extends F8{B(){const m=[];this.X.details&&m.push(this.X.details);this.X.userDetails&&m.push(this.X.userDetails);return[...(new Set(m))]}},musicArtistUserDetail:class extends F8{B(){const m=[];this.X.parentArtist&&m.push(this.X.parentArtist);return[...(new Set(m))]}},musicDownloadsLibraryEntity:class extends F8{B(){const m=[];this.X.downloadedTracks&&m.push(...this.X.downloadedTracks);this.X.smartDownloadedTracks&&m.push(...this.X.smartDownloadedTracks);this.X.downloadedEpisodes&&
m.push(...this.X.downloadedEpisodes);this.X.downloadedAlbumReleases&&m.push(...this.X.downloadedAlbumReleases);this.X.smartDownloadedAlbumReleases&&m.push(...this.X.smartDownloadedAlbumReleases);this.X.downloadedPlaylists&&m.push(...this.X.downloadedPlaylists);this.X.smartDownloadedPlaylists&&m.push(...this.X.smartDownloadedPlaylists);this.X.metadataOnlyTracks&&m.push(...this.X.metadataOnlyTracks);return[...(new Set(m))]}},musicLibraryEdit:class extends F8{B(){return[]}},musicLibraryStatusEntity:class extends F8{B(){return[]}},
musicPlaylist:class extends F8{B(){const m=[];this.X.tracks&&m.push(...this.X.tracks);this.X.refresh&&m.push(this.X.refresh);this.X.musicLibraryStatusEntity&&m.push(this.X.musicLibraryStatusEntity);this.X.details&&m.push(this.X.details);this.X.downloadMetadata&&m.push(this.X.downloadMetadata);this.X.sideloadMetadata&&m.push(this.X.sideloadMetadata);this.X.userDetails&&m.push(this.X.userDetails);this.X.entryCollection&&m.push(this.X.entryCollection);this.X.share&&m.push(this.X.share);this.X.podcastShowAdditionalMetadata&&
m.push(...(new TZ8(this.X.podcastShowAdditionalMetadata)).B());return[...(new Set(m))]}},musicPlaylistDownloadMetadataEntity:class extends F8{B(){const m=[];this.X.trackDownloadMetadatas&&m.push(...this.X.trackDownloadMetadatas);return[...(new Set(m))]}},musicShare:class extends F8{B(){return[]}},musicTrackDetail:class extends F8{B(){const m=[];this.X.parentTrack&&m.push(this.X.parentTrack);return[...(new Set(m))]}},musicTrackDownloadMetadataEntity:class extends F8{B(){const m=[];this.X.playbackData&&
m.push(this.X.playbackData);this.X.localImageEntities&&m.push(...this.X.localImageEntities);this.X.videoDownloadContextEntity&&m.push(this.X.videoDownloadContextEntity);return[...(new Set(m))]}},musicTrack:class extends F8{B(){const m=[];this.X.musicLibraryStatusEntity&&m.push(this.X.musicLibraryStatusEntity);this.X.artists&&m.push(...this.X.artists);this.X.audioModeVersion&&m.push(this.X.audioModeVersion);this.X.videoModeVersion&&m.push(this.X.videoModeVersion);this.X.userDetails&&m.push(this.X.userDetails);
this.X.details&&m.push(this.X.details);this.X.albumRelease&&m.push(this.X.albumRelease);this.X.share&&m.push(this.X.share);this.X.libraryEdit&&m.push(this.X.libraryEdit);this.X.downloadMetadata&&m.push(this.X.downloadMetadata);this.X.playbackPosition&&m.push(this.X.playbackPosition);this.X.lyrics&&m.push(this.X.lyrics);return[...(new Set(m))]}},musicTrackUserDetail:class extends F8{B(){const m=[];this.X.parentTrack&&m.push(this.X.parentTrack);return[...(new Set(m))]}},offlineOrchestrationActionWrapperEntity:class extends F8{B(){return[]}},
offlineVideoPolicy:class extends F8{B(){return[]}},offlineVideoStreams:class extends F8{B(){return[]}},offlineabilityEntity:class extends F8{B(){return[]}},orchestrationWebSamplingEntity:class extends F8{B(){const m=[];this.X.fakeChildren&&m.push(...this.X.fakeChildren);return[...(new Set(m))]}},pageHeaderEntity:class extends F8{B(){return[]}},pdpStateEntity:class extends F8{B(){return[]}},pinnedProductEntity:class extends F8{B(){return[]}},playbackData:class extends F8{B(){const m=[];this.X.transfer&&
m.push(this.X.transfer);this.X.adsPlaybackData&&m.push(...this.X.adsPlaybackData);this.X.drmLicense&&m.push(this.X.drmLicense);this.X.offlineVideoPolicy&&m.push(this.X.offlineVideoPolicy);this.X.videoDownloadContextEntity&&m.push(this.X.videoDownloadContextEntity);return[...(new Set(m))]}},playerStateEntity:class extends F8{B(){return[]}},quantityIncrementerEntity:class extends F8{B(){return[]}},refresh:class extends F8{B(){return[]}},saveToPlaylistListEntity:class extends F8{B(){return[]}},selectedChipIndexEntityPayload:class extends F8{B(){return[]}},
settingEntity:class extends F8{B(){return[]}},stringEntity:class extends F8{B(){return[]}},suggestedFeedbackChipStateEntity:class extends F8{B(){return[]}},transfer:class extends F8{B(){const m=[];this.X.offlineVideoStreams&&m.push(...this.X.offlineVideoStreams);this.X.captionTrack&&m.push(...this.X.captionTrack);return[...(new Set(m))]}},trendingOfferEntity:class extends F8{B(){return[]}},videoDownloadContextEntity:class extends F8{B(){return[]}},videoOverviewAsyncDataEntity:class extends F8{B(){return[]}},
videoPlaybackPositionEntity:class extends F8{B(){return[]}},votingEntity:class extends F8{B(){return[]}},ytMainChannelEntity:class extends F8{B(){const m=[];this.X.userChannelDetails&&m.push(this.X.userChannelDetails);return[...(new Set(m))]}},youchatPendingResponseEntity:class extends F8{B(){return[]}},ytMainDownloadedVideoEntity:class extends F8{B(){const m=[];this.X.video&&m.push(this.X.video);this.X.playbackData&&m.push(this.X.playbackData);this.X.offlineVideoPolicy&&m.push(this.X.offlineVideoPolicy);
return[...(new Set(m))]}},ytMainVideoEntity:class extends F8{B(){const m=[];this.X.channelOwner&&m.push(this.X.channelOwner);this.X.playbackPosition&&m.push(this.X.playbackPosition);this.X.localImageEntities&&m.push(...this.X.localImageEntities);this.X.downloadStatus&&m.push(this.X.downloadStatus);return[...(new Set(m))]}}},vqc=class{constructor(m,F){this.X=m;this.B=F;this.G={}}},fIc=class extends pwG{G(m){return m}B(m){if(m instanceof Uint8Array)throw new i_("WRONG_DATA_TYPE",{aO:0});return m}},
V_e=class{constructor(){this.X={};this.X[0]=new fIc;if(!g.tw("aes_pes_encoder_killswitch")){var m=this.X;try{const u=g.ej();var F=gk(u);var L=new KAN(new g.k5(F),new g.Sk(F))}catch(u){throw m=u instanceof Error?new i_("KEY_CREATION_FAILED",{originalMessage:u.message}):new i_("KEY_CREATION_FAILED"),g.Q(m),m;}m[1]=L}}},juC=class extends g.qt{constructor(m,F){super();this.token=m;this.X=F;this.observers=[];m=new g.On.BroadcastChannel(`${"PERSISTENT_ENTITY_STORE_SYNC"}:${g.ej()}`);m.onmessage=this.B.bind(this);
this.channel=m}observe(m){this.observers.push(m);return()=>{const F=this.observers.indexOf(m);F>=0&&this.observers.splice(F,1)}}B(m){GfC(this,m.data)}IW(){this.channel.close()}},tD,CmN=new g.C("elementsCommand");var $l=new g.C("entityBatchUpdate");var bGG=new g.C("downloadStatusEntity");var tgZ=new g.C("mainPlaylistEntityActionMetadata");var Bb=new g.C("mainVideoEntityActionMetadata");var GaC=new g.C("musicPlaylistEntityActionMetadata");var CZ=new g.C("musicTrackEntityActionMetadata");var B4C=new g.C("localImageEntityActionMetadata");var fZ=new g.C("playbackDataActionMetadata");var WQC=new g.C("transferEntityActionMetadata");var MvC=new g.C("videoPlaybackPositionEntityActionMetadata");var phc=class{constructor(){this.X=new Map}},kV;new g.lT;new g.lT;var ZG2=class{constructor(){this.locks=navigator.locks}request(m,F={},L){return this.locks.request(m,F,u=>L(u))}};var OT=g.On.caches,WU,Qx,xOf=class{open(m){return OT.open(hD(m))}has(m){return OT.has(hD(m))}delete(m){return OT.delete(hD(m))}async match(m,F){var L=await this.keys();for(const u of L)if(L=await (await this.open(u)).match(m,F))return L}},XhC=class extends xOf{async keys(){const m=[],F=g.ej("CacheStorage keys");var L=await OT.keys();for(const u of L){L=u.indexOf(":");const {GT:q,datasyncId:A}=L===-1?{GT:u}:{GT:u.substring(0,L),datasyncId:u.substring(L+1)};A===F&&m.push(q)}return m}};var MrN=class extends g.qt{constructor(m){super();this.api=m;this.fI={dy0:()=>this.X,
lX8:()=>this.B};
typeof g.On.BroadcastChannel!=="undefined"&&(this.X=new g.On.BroadcastChannel(`${"PLAYER_OFFLINE_ERROR_SYNC"}:${g.ej()}`),this.X.onmessage=this.G.bind(this),this.B=new g.On.BroadcastChannel(`${"PLAYER_OFFLINE_PAUSE_SYNC"}:${g.ej()}`),this.B.onmessage=this.V.bind(this))}G(m){g.sP(this.api,"onOfflineOperationFailure",m.data)}V(m){this.api.publish("offlinetransferpause",m.data)}IW(){this.X?.close();this.B?.close()}};var Z18=class{constructor(m,F,L){this.Z=m;this.W=F;this.visibility=L;this.O=this.L=this.j=this.G=this.X=!1;this.V=new g.d1(()=>{this.W8()});
this.fI={xm:()=>this.B,
W8:()=>{this.W8()},
UHz:()=>this.V};
this.visibility.subscribe("visibilitystatechange",()=>{this.Gy()})}Gy(){this.X&&dk(this)}W8(){this.B&&this.B.resolve();
this.G=this.X=!1;this.W()}};var qoe=["OFFLINE_ORCHESTRATION_ACTION_TYPE_ADD","OFFLINE_ORCHESTRATION_ACTION_TYPE_REFRESH"];var GQ=class{constructor(m,F,L,u,q=F,A,r,y,G,v,l){this.entityType=m;this.actionId=F;this.action=L;this.parentActionId=u;this.rootActionId=q;this.childActionIds=A;this.prereqActionId=r;this.postreqActionIds=y;this.hasChildActionFailed=v;this.retryScheduleIndex=0;this.X=l||Date.now();this.retryScheduleIndex=G||0}};var HGc="captionTrack downloadStatusEntity ytMainChannelEntity mainPlaylistEntity mainPlaylistDownloadStateEntity mainPlaylistVideoEntity mainVideoEntity mainVideoDownloadStateEntity offlineVideoPolicy offlineVideoStreams playbackData transfer videoDownloadContextEntity videoPlaybackPositionEntity".split(" ");var AuC="downloadStatusEntity musicAlbumRelease musicDownloadsLibraryEntity musicPlaylist musicTrack musicTrackDownloadMetadataEntity offlineVideoPolicy offlineVideoStreams playbackData transfer videoDownloadContextEntity".split(" ");var LO=class{constructor(m){this.X=m}},Mw=class{constructor(m,F,L,u,q,A){this.status=m;this.X=F;this.V=L;this.B=u;this.G=q;this.downloadState=A}};var S4G=class extends LO{constructor(m,F,L){super(m);this.X=m;this.S=F;this.G=L}B(m){return JD(m)?NuG(this,m):C6(m)?f28(this,m):Promise.reject(Error(`Unsupported action type: ${m.actionType}`))}};var oB6=class extends LO{constructor(m,F){super(m);this.X=m;this.S=F}B(m){return C6(m)?xuN(this,m):suG(m)?ZYG(this,m):mG(m)?SGC(this,m):Promise.reject(Error(`Unsupported action type: ${m.actionType}`))}};var XwC=class{constructor(m,F){this.api=m;this.X=F;this.logger=new g.PK("woffle");this.B=!1;this.fI={Mf:this.Mf}}async V(m){if(m.state.X(128)){const F=m.state.O$;m=F?.errorCode;m=m==="net.connect"&&F?.qV===1?"TRANSFER_FAILURE_REASON_NETWORK_LOST":m?.startsWith("net.")?"TRANSFER_FAILURE_REASON_NETWORK":"TRANSFER_FAILURE_REASON_INTERNAL";await this.D3(this.player.getVideoData().videoId,m)}}async D3(m,F){this.B||(this.B=!0,F==="TRANSFER_FAILURE_REASON_NETWORK_LOST"?Xo(this,m,!1,!0):(await o5(this,m),
g.XO(m,4),await this.X.D3(F)))}CQ(m){m.status===2?(m.status!==this.G&&(se(this.X),g.XO(m.videoId,2)),m.Zh&&Ike(this.X,m.videoId,m.Zh)):m.status===4?(o5(this,m.videoId),this.D3(m.videoId,m.Ba?"TRANSFER_FAILURE_REASON_FILESYSTEM_WRITE":"TRANSFER_FAILURE_REASON_INTERNAL")):m.status===1&&$Qq(this.X);this.G=m.status;g.sP(this.api,"localmediachange",{videoId:m.videoId,status:m.status})}async xt(){if(!this.B){this.B=!0;var m=this.player.getVideoData().videoId;await o5(this,m);await this.X.xt()}}Mf(m){switch(m){case "HD_1080":return"hd1080";
case "HD":return"hd720";case "SD":return"large";case "LD":return"tiny";default:return"hd720"}}N(m){return this.api.K().N(m)}};var trG=class extends LO{constructor(m,F){super(m);this.X=m;this.S=F}B(m){return JD(m)?UuZ(this,m):C6(m)?kaf(this,m):suG(m)?h7e(this,m):Promise.reject(Error(`Unsupported action type: ${m.actionType}`))}};var EBG=class{constructor(){this.actions=[]}X(m,F){let L=m.action.actionMetadata.priority-F.action.actionMetadata.priority;L===0&&(m.X<F.X?L=-1:m.X>F.X&&(L=1));return L}};var duq=class extends g.qt{constructor(m,F,L,u,q){super();this.B=m;this.hF=F;this.XN=L;this.L=u;this.S=q;this.X=new EBG;this.j=new g.jp;this.G=new g.d1(()=>{this.retry()});
this.Z=NaN;this.O=!1;this.fI={ErF:()=>this.X,
Np:()=>this.j,
YLc:()=>this.G,
retry:()=>this.retry()};
g.Z(this,this.G);this.W=this.B.observe(this.T.bind(this))}IW(){this.W&&this.W();super.IW()}createAction(m,F){const L=g.cf(m.entityKey).entityType,u=g.$H(16);return new GQ(L,u,m,F.actionId,F.rootActionId)}async T(m){if(!this.jY()){var F=m.offlineOrchestrationActionWrapperEntity??new Set;m=[];for(var L of F)({entityId:F}=g.cf(L)),cuq(this.X,F)||m.push(L);L=await LgR(this,m);await Ue(this,L)}}async retry(){await rLR(this)}};var UOf=class{constructor(m){this.w8=m;this.X=void 0}async SJ(m,F=!0){if(this.X){var L=[],u=g.Cq(this.X.X,F),q=[];for(let A=0;A<u.length;A++)F=this.X.j(u[A],"json3"),F=g.Jw(F,{withCredentials:!0,format:"RAW"},3,500).then(r=>{r={metadata:g.ez(u[A]),trackData:r.xhr.responseText};q.push(r)}).cW(r=>{b_("Caption fetch error",r)}),L.push(F);
await cPt(L);try{await zSe(m,q)}catch(A){b_("Caption DB transaction error",A)}}}};var kr2=class extends g.qt{constructor(m){super();this.X=m;this.B=this.X.observe(this.G.bind(this))}IW(){this.B&&this.B();super.IW()}async G(m){var F=m.transfer??new Set;m=[];for(const L of F)({entityId:F}=g.cf(L)),m.push(F);m.length!==0&&await vnm(this,m)}};var Kgq=class extends g.qt{constructor(m,F,L,u){super();this.B=m;this.api=F;this.xC=L;this.T=u;this.j=new g.jp;this.V=new g.d1(()=>{this.X&&this.X.transferState==="TRANSFER_STATE_TRANSFERRING"&&this.j.X2()&&((this.X.transferRetryCount||0)<3?Xo(this.L,this.O,!1,!1):o5(this.L,this.O.videoDetails.videoId),this.D3("TRANSFER_FAILURE_REASON_TIMEOUT_NO_PROGRESS"))});
this.XN=this.Hb=0;this.W=this.Z=!1;this.JF=g.Ek(this.api.K().experiments,"html5_transfer_processing_logs_interval");this.OR=new g.uf(this);this.fI={KA0:()=>this.V,
IXC:()=>this.T,
Np:()=>this.j};
this.hF=this.B.observe(this.sR.bind(this));this.L=new XwC(F,this);this.i9=new UOf(F);this.b9=new kr2(this.B);this.tF=this.j.listen("publicytnetworkstatus-online",this.Dx.bind(this));this.M0=this.j.listen("publicytnetworkstatus-offline",this.FN.bind(this));this.W=this.api.K().N("html5_less_transfer_processing_logs");g.Z(this,this.OR);this.OR.A(F,"offlinetransferpause",this.Cu);if(g.mm(this.api.K()))this.G="mainVideoDownloadStateEntity";else if(g.Qf(this.api.K())||g.Ll(this.api.K()))this.G="musicTrackDownloadMetadataEntity"}IW(){this.hF&&
this.hF();this.b9.dispose();this.V.dispose();this.tF&&g.Vu(this.j.yN,this.tF);this.M0&&g.Vu(this.j.yN,this.M0);super.IW()}async Cu(m){const F=g.dD(m,"transfer");if(this.X&&F===this.X.key)Xo(this.L,this.O,!0),this.V.stop();else{const L=await ME(this.B,{mode:"readwrite",JW:!0},u=>aA(u,F,"transfer").then(q=>{if(q&&q.transferState!=="TRANSFER_STATE_COMPLETE"&&q.transferState!=="TRANSFER_STATE_FAILED")return q.transferState="TRANSFER_STATE_PAUSED_BY_USER",p6(u,q,"transfer").then(()=>q)}));
if(L){m&&this.G&&await Fo(m,this.G,this.B,"DOWNLOAD_STATE_PAUSED");const u=await h3(this,m);OGq({videoId:m,cM:L,offlineModeType:u})}}}FN(){if(this.X&&this.O){Xo(this.L,this.O,!1);const m=this.X,F=m?.key?g.cf(m.key).entityId:"";F&&this.G&&(new Promise((L,u)=>{Fo(F,this.G,this.B,"DOWNLOAD_STATE_PAUSED").catch(q=>{u(q)})})).catch(L=>{b_("Download state setting error",L)})}this.V.stop()}Dx(){this.X?ak6(this,this.X):Qp(this)}async sR(m){if(this.X&&(this.X.transferState!=="TRANSFER_STATE_COMPLETE"&&this.X.transferState!==
"TRANSFER_STATE_FAILED"&&m.transfer&&m.transfer.has(this.X.key)&&((this.X=await oA(this.B,this.X.key,"transfer"))||await DQm(this)),this.X))return;
await Qp(this)}async D3(m,F){if(this.X){var L=this.X;const q=L?.key?g.cf(L.key).entityId:"";a:switch(m){case "TRANSFER_FAILURE_REASON_FILESYSTEM_WRITE":case "TRANSFER_FAILURE_REASON_EXTERNAL_FILESYSTEM_WRITE":case "TRANSFER_FAILURE_REASON_PLAYABILITY":case "TRANSFER_FAILURE_REASON_TOO_MANY_RETRIES":var u=!1;break a;default:u=!0}u&&T4e(this)?(await kl(this,"TRANSFER_STATE_TRANSFER_IN_QUEUE"),m=await h3(this,q),BU({transferStatusType:"TRANSFER_STATUS_TYPE_REENQUEUED_BY_RETRY"},{videoId:q,cM:L,offlineModeType:m}),
q&&this.G&&await Fo(q,this.G,this.B,"DOWNLOAD_STATE_RETRYABLE_FAILURE")):(await N4Z(this,m),q&&this.G&&await Fo(q,this.G,this.B,"DOWNLOAD_STATE_FAILED"))}else Wb(this,`onTransferFailure: ${m}`);Oe(this);L=Qp(this,!0);F&&F(L)}async xt(m){if(this.X)if(T4e(this)){await kl(this,"TRANSFER_STATE_WAITING_FOR_PLAYER_RESPONSE_REFRESH");this.X||Wb(this,"onMaybeTransferStreamsExpiredRetryAttempting");var F=this.X,L=F?.key?g.cf(F.key).entityId:"",u=await h3(this,L);BU({transferStatusType:"TRANSFER_STATUS_TYPE_DEQUEUED_BY_PLAYER_RESPONSE_EXPIRATION"},
{videoId:L,cM:F,offlineModeType:u});F=yp();g.Xc(F,fZ,{isEnqueuedForExpiredStreamUrlRefetch:!0});u=g.dD(L,"playbackData");L=lX(new GQ("playbackData",L,{actionType:"OFFLINE_ORCHESTRATION_ACTION_TYPE_ADD",entityKey:u,actionMetadata:F}));await Z7(this.B,L,"offlineOrchestrationActionWrapperEntity")}else await N4Z(this,"TRANSFER_FAILURE_REASON_STREAM_MISSING"),this.G&&(L=this.X,(L=L?.key?g.cf(L.key).entityId:"")&&await Fo(L,this.G,this.B,"DOWNLOAD_STATE_FAILED"));else Wb(this,"onMaybeTransferStreamsExpired");
Oe(this);L=Qp(this,!0);m&&m(L)}},bX={TRANSFER_STATE_TRANSFERRING:1,TRANSFER_STATE_TRANSFER_IN_QUEUE:2};var h58=class{constructor(m,F){this.S=m;this.api=F;this.L=new g.jp;this.O=new g.lT;this.fI={xm:()=>this.G.fI.xm(),
Np:()=>this.L,
Hw0:()=>this.G,
Od:()=>this.Od(),
Md:()=>this.Md(),
Ez:()=>this.Ez(),
KE:()=>this.KE(),
wr:()=>this.wr(),
jn:L=>this.jn(L)};
this.G=new Z18(()=>pyc(this),()=>{this.Ez()},this.api.R9(),this.api.N.bind(this.api));
this.X=new MrN(this.api);EqZ(this.G)}Od(){return this.O.promise}Md(){if(this.B&&this.Z)return this.O.promise;xQR(this).then(this.O.resolve).catch(this.O.reject);return this.O.promise}j(m){return{playbackData:new S4G(m,this.S,this.X),transfer:new trG(m,this.S),videoPlaybackPositionEntity:new oB6(m,this.S)}}async KE(){this.B&&await ekc(this.B)}async Ez(){if(this.B||this.Z)await this.Od(),this.XN!==void 0&&(g.o9(this.XN),this.XN=void 0),this.V!==void 0&&(g.o9(this.V),this.V=void 0),this.B?.dispose(),
this.B=void 0,this.Z?.dispose(),this.Z=void 0,g.sP(this.api,"onOrchestrationLostLeader"),this.O=new g.lT}isOrchestrationLeader(){return this.G.X}async b9(){return!1}qF(m){var F=this.X;F.api.publish("offlinetransferpause",m);F.B?.postMessage(m)}async Dx(m){const F=await ET();if(F){var L=g.dD(m,"transfer");await ME(F,{mode:"readwrite",JW:!0},u=>{const q=aA(u,L,"transfer"),A=aA(u,g.dD(m,"videoDownloadContextEntity"),"videoDownloadContextEntity");return g.hW.all([q,A]).then(([r,y])=>r&&r.transferState===
"TRANSFER_STATE_PAUSED_BY_USER"?(r.transferState="TRANSFER_STATE_TRANSFER_IN_QUEUE",p6(u,r,"transfer").then(()=>{BU({transferStatusType:"TRANSFER_STATUS_TYPE_REENQUEUED_BY_USER_RESUME",statusType:"USER_RESUMED"},{videoId:m,cM:r,offlineModeType:y?.offlineModeType});return g.hW.resolve(null)})):g.hW.resolve(null))})}}async hF(m=43200){if(!this.L.X2())return Mgm();
var F=await ET();if(!F)return[];const L=Date.now()/1E3;var u=await Xu(F,"offlineVideoPolicy");F=[];for(const q of u)Number(q.lastUpdatedTimestampSeconds)+m<=L&&(u=g.cf(q.key).entityId,F.push(u));return F.length?cb(this,F,this.T,"OFFLINE_ORCHESTRATION_ACTION_TYPE_REFRESH"):[]}deleteAll(){return cb(this,["!*$_ALL_ENTITIES_!*$"],this.T,"OFFLINE_ORCHESTRATION_ACTION_TYPE_DELETE",{offlineLoggingData:{offlineDeleteReason:"OFFLINE_DELETE_REASON_USER_INITIATED"}})}async refreshAllStaleEntities(m){return await this.hF(m)}setUpPositionSyncInterval(m){this.V!==
void 0&&(g.o9(this.V),this.V=void 0);const F=m??864E5;this.V=g.Zp(()=>{this.jn(F)},F)}async jn(m){try{const F=await ZQ.getInstance();
if(!F)throw Error("prefStorage is undefined");const L=await F.get("psi"),u=L?.pZ?Number(L.pZ)/1E3:0,q=Date.now();u+m<=q&&await cb(this,["!*$_ALL_ENTITIES_!*$"],"videoPlaybackPositionEntity","OFFLINE_ORCHESTRATION_ACTION_TYPE_REFRESH")}catch(F){b_("Offline manager error",F)}}async wr(){var m=await ET();if(!m)return[];var F=await Xu(m,"transfer");m=[];for(const L of F)L.transferState==="TRANSFER_STATE_WAITING_FOR_PLAYER_RESPONSE_REFRESH"&&L.key&&(F=g.cf(L.key).entityId,m.push(F));return SoC(this,m)}async W(){return[]}async M0(){}async Hb(){}};var WAt=class extends LO{constructor(m,F,L){super(m);this.X=m;this.S=F;this.G=L}B(m){return JD(m)?XyC(this,m):C6(m)?Ene(this,m):mG(m)?UQN(this,m):Promise.reject(Error(`Unsupported action type: ${m.actionType}`))}},d5=[10];var O1f=class extends LO{constructor(m,F,L){super(m);this.X=m;this.S=F;this.G=L}B(m){return JD(m)?bJ8(this,m):C6(m)?cLN(this,m):mG(m)?dQ2(this,m):Promise.reject(Error(`Unsupported action type: ${m.actionType}`))}},s$e=[10];var QeN=class extends LO{constructor(m,F,L){super(m);this.X=m;this.S=F;this.G=L}B(m){return C6(m)?HJ2(this,m):Promise.reject(Error(`Unsupported action type: ${m.actionType}`))}};var seC=class extends h58{constructor(){super(...arguments);this.T="mainVideoEntity"}j(m){const F=super.j(m);F.mainVideoEntity=new O1f(m,this.S,this.X);F.mainPlaylistEntity=new WAt(m,this.S,this.X);F.mainDownloadsListEntity=new QeN(m,this.S,this.X);return F}async refreshAllStaleEntities(m,F){let L=[];this.S.N("web_player_offline_playlist_auto_refresh")&&(L=await JLR(this,m,F));var u=await ZQ.getInstance();const q=await u?.get("sdois");u=await u?.get("lmqf");q&&(L=L.concat(await CRf(this,q,u??"SD",
m===0)));return L=L.concat(await super.refreshAllStaleEntities(m,F))}async b9(m){var F=await ET();if(!F)return!1;F=await oA(F,g.Ox,"mainDownloadsListEntity");if(F?.downloads?.length){m=g.dD(m,"mainVideoEntity");for(const L of F.downloads)if(L.videoItem===m)return!0}return!1}async W(){var m=await ET();if(!m)return[];var F=await Xu(m,"downloadStatusEntity");m=[];for(const L of F)L.downloadState==="DOWNLOAD_STATE_USER_DELETED"&&L.key&&(F=g.cf(L.key).entityId,m.push(F));return m.length?cb(this,m,"mainVideoEntity",
"OFFLINE_ORCHESTRATION_ACTION_TYPE_DELETE",{offlineLoggingData:{offlineDeleteReason:"OFFLINE_DELETE_REASON_USER_INITIATED"}}):[]}async Hb(){const m=await ET();m&&await ME(m,{mode:"readwrite",JW:!0},F=>D7(F,"mainVideoEntity").then(L=>{const u=[];for(const q of L)q.userState?.playbackPosition||(L=g.cf(q.key).entityId,L={key:g.dD(L,"videoPlaybackPositionEntity"),videoId:L,lastPlaybackPositionSeconds:"0"},u.push(p6(F,L,"videoPlaybackPositionEntity")),q.userState={playbackPosition:L.key},u.push(p6(F,q,
"mainVideoEntity")));return g.hW.all(u)}))}async M0(){const m=await ET();
if(m){var F=g.dD("DOWNLOADS_LIST_ENTITY_ID_MANUAL_DOWNLOADS","mainDownloadsListEntity"),L=await ME(m,{mode:"readonly",JW:!0},w=>g.hW.all([aA(w,F,"mainDownloadsListEntity"),aA(w,g.Ox,"mainDownloadsListEntity"),D7(w,"mainVideoEntity"),D7(w,"mainPlaylistEntity")])),[u,
q,A,r]=L;L=new Set;if(u?.downloads?.length)for(var y of u.downloads){var G=y.videoItem??y.playlistItem;G&&L.add(G)}if(q?.downloads?.length)for(var v of q.downloads)v.videoItem&&L.add(v.videoItem);y=new Set;v=[];for(var l of r){if(l.videos)for(const w of l.videos)(G=JSON.parse(g.cf(w).entityId).videoId)&&y.add(G);l.key&&!L.has(l.key)&&v.push(l.key)}for(const w of A)w.key&&!L.has(w.key)&&(l=g.cf(w.key).entityId,y.has(l)||v.push(w.key));v.length&&await e$(m,v)}}};var b1t=class extends LO{constructor(m,F){super(m);this.X=m;this.G=F}B(m){return JD(m)?FAR(this,m):C6(m)?LA2(this,m):mG(m)?u5c(this,m):Promise.reject(Error(`Unsupported action type: ${m.actionType}`))}},Hb=[10];var c76=class extends LO{constructor(m,F){super(m);this.X=m;this.G=F}B(m){return JD(m)?r7Z(this,m):C6(m)?y7f(this,m):mG(m)?GrC(this,m):Promise.reject(Error(`Unsupported action type: ${m.actionType}`))}},J3=[10];var dO8=class extends LO{constructor(m,F){super(m);this.X=m;this.G=F}B(m){return JD(m)?jeq(this,m):C6(m)?IIt(this,m):mG(m)?R58(this,m):Promise.reject(Error(`Unsupported action type: ${m.actionType}`))}},VrC=[10];var nBG=class extends h58{constructor(){super(...arguments);this.T="musicTrack"}j(m){const F=super.j(m);F.musicTrack=new dO8(m,this.X);F.musicPlaylist=new c76(m,this.X);F.musicAlbumRelease=new b1t(m,this.X);return F}async refreshAllStaleEntities(m,F){let L=await e5G(this,m,F);return L=L.concat(await super.refreshAllStaleEntities(m,F))}};g.PC("offline",class extends g.gB{constructor(){super(...arguments);this.events=new g.uf(this);this.S=this.player.K();this.fI={VUP:()=>this.X,
CC:()=>this.CC(),
Pr:m=>this.Pr(m)}}create(){g.Z(this,this.events);
if(g.mm(this.S))this.X=new seC(this.S,this.player);else if(g.Qf(this.S)||g.Ll(this.S))this.X=new nBG(this.S,this.player);this.events.A(this.player,"onPlaybackStartExternal",()=>{this.CC()});
this.events.A(this.player,"videodatachange",()=>{this.CC()});
this.S.N("html5_offline_playback_position_sync")&&this.events.A(this.player,"presentingplayerstatechange",this.Pr)}EW(){return!1}async uC(m,F,L,u){return this.X?cb(this.X,m,F,L,u):Promise.reject()}deleteAll(){return this.X.deleteAll()}hF(m){return this.X.hF(m)}refreshAllStaleEntities(m){return this.X.refreshAllStaleEntities(m)}setUpPositionSyncInterval(m){this.X.setUpPositionSyncInterval(m)}qF(m){this.X.qF(m)}Dx(m){return this.X.Dx(m)}async CC(){const m=this.player.getVideoData();m.tW()&&PAm(m)&&
this.B!==m.clientPlaybackNonce&&await i1f(this,m)}async Pr(m){var F=this.player.getVideoData();const L=F.j0;if(m.aH(2)||m.aH(512))(m=await ET())?(F=F.videoId,await oA(m,g.dD(F,"mainVideoEntity"),"mainVideoEntity")&&await this.uC([F],"videoPlaybackPositionEntity","OFFLINE_ORCHESTRATION_ACTION_TYPE_UPDATE",{videoPlaybackPositionEntityActionMetadata:{lastPlaybackPositionSeconds:Math.floor(L).toString()}})):b_("PES is undefined")}isOrchestrationLeader(){return this.X.isOrchestrationLeader()}async updateDownloadState(m,
F){const L=await ET();if(L){var {entityType:u,entityId:q}=g.cf(m);await Fo(q,u,L,F,!0)}else b_("PES is undefined")}});})(_yt_player);
